{% load static %}
<!DOCTYPE html>
<html lang="uz" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FayltopAi fayl qidiruv</title>
    <link rel="icon" type="image/x-icon" href="{% static 'icon.png' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',
                        secondary: '#06b6d4',
                        dark: '#0f172a',
                        light: '#f8fafc'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; color: #0f172a; background: #f8fafc; }
        
        /* Custom animations and effects (unchanged) */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes shimmer { 0% { background-position: -200px 0; } 100% { background-position: calc(200px + 100%) 0; } }
        @keyframes bounce { 0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); } 40%, 43% { transform: translate3d(0, -8px, 0); } 70% { transform: translate3d(0, -4px, 0); } 90% { transform: translate3d(0, -2px, 0); } }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .animate-fadeInUp { animation: fadeInUp 0.8s ease-out; }
        .animate-fadeInLeft { animation: fadeInLeft 0.8s ease-out; }
        .animate-fadeInRight { animation: fadeInRight 0.8s ease-out; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-bounce { animation: bounce 1s infinite; }
        .hover-lift { transition: all 0.3s ease; }
        .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .hover-scale { transition: all 0.3s ease; }
        .hover-scale:hover { transform: scale(1.05); }
        .hover-glow { transition: all 0.3s ease; }
        .hover-glow:hover { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .hover-bloom { transition: filter 0.35s ease, box-shadow 0.35s ease; }
        .hover-bloom:hover { filter: saturate(1.15) contrast(1.03); box-shadow: 0 14px 40px rgba(0,0,0,0.18); }
        .hover-shadow-xl { transition: box-shadow 0.35s ease, transform 0.2s ease; }
        .hover-shadow-xl:hover { box-shadow: 0 18px 55px rgba(0,0,0,0.22); transform: translateY(-2px); }
        .hover-glass-pop { transition: background 0.35s ease, border-color 0.35s ease, box-shadow 0.35s ease; background: rgba(255, 255, 255, 0.10); border: 1px solid rgba(255, 255, 255, 0.14); }
        .hover-glass-pop:hover { background: rgba(255, 255, 255, 0.16); border-color: rgba(255, 255, 255, 0.28); box-shadow: inset 0 1px 0 rgba(255,255,255,0.18), 0 10px 30px rgba(0,0,0,0.16); }
        .hover-underline-slide { position: relative; }
        .hover-underline-slide::after { content: ''; position: absolute; left: 50%; bottom: -2px; width: 0; height: 2px; background: currentColor; transition: width 0.3s ease, left 0.3s ease; }
        .hover-underline-slide:hover::after { width: 100%; left: 0; }
        .gradient-animated { background: linear-gradient(-45deg, #4f46e5, #0ea5e9, #14b8a6, #60a5fa); background-size: 400% 400%; animation: gradientShift 8s ease infinite; }
        .hero-bg-container { position: absolute; inset: 0; overflow: hidden; z-index: 0; }
        .hero-bg-video, .hero-bg-image { position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; width: auto; height: auto; transform: translate(-50%, -50%); object-fit: cover; filter: saturate(1.1) contrast(1.05) brightness(0.9); }
        .hero-overlay { position: absolute; inset: 0; background: radial-gradient(1200px 600px at 10% -10%, rgba(0,0,0,0.25), transparent 60%), linear-gradient(180deg, rgba(0,0,0,0.35) 0%, rgba(0,0,0,0.55) 100%); z-index: 1; }
        .ignite-mode .hero-overlay { background: radial-gradient(1200px 600px at 10% -10%, rgba(249, 115, 22, 0.20), transparent 60%), linear-gradient(180deg, rgba(0,0,0,0.35) 0%, rgba(0,0,0,0.6) 100%); }
        .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200px 100%; animation: shimmer 1.5s infinite; }
        .ios-modal { opacity: 0; backdrop-filter: blur(0px); transition: opacity 420ms ease, backdrop-filter 420ms ease; }
        .ios-modal.open { opacity: 1; backdrop-filter: blur(8px); }
        .ios-sheet { transform: translateY(24px) scale(0.98); opacity: 0; transition: transform 520ms cubic-bezier(.22,.61,.36,1), opacity 380ms ease, box-shadow 380ms ease; will-change: transform, opacity; }
        .ios-modal.open .ios-sheet { transform: translateY(0) scale(1); opacity: 1; box-shadow: 0 24px 60px rgba(0,0,0,0.25); }
        .stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; } .stagger-4 { animation-delay: 0.4s; } .stagger-5 { animation-delay: 0.5s; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; } ::-webkit-scrollbar-thumb { background: linear-gradient(45deg, #667eea, #764ba2); border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: linear-gradient(45deg, #5a67d8, #6b46c1); }
        :root { --fire-50: #fff7ed; --fire-100: #ffedd5; --fire-200: #fed7aa; --fire-300: #fdba74; --fire-400: #fb923c; --fire-500: #f97316; --fire-600: #ea580c; --fire-700: #c2410c; --fire-800: #9a3412; --fire-900: #7c2d12; }
        .ignite-mode { background: radial-gradient(1200px 600px at 20% -10%, rgba(249, 115, 22, 0.35), transparent 60%), radial-gradient(900px 500px at 110% 10%, rgba(251, 146, 60, 0.25), transparent 60%), linear-gradient(135deg, var(--fire-600) 0%, var(--fire-700) 40%, var(--fire-800) 100%) !important; position: relative; isolation: isolate; transition: background 900ms ease, box-shadow 900ms ease; }
        .ignite-mode::before { content: ''; position: absolute; inset: -10% -10% -10% -10%; background: conic-gradient(from 180deg at 50% 50%, rgba(255,255,255,0.08), rgba(255,255,255,0.02), rgba(255,255,255,0.08)); filter: blur(40px); pointer-events: none; z-index: -1; }
        .ignite-mode .gradient-animated { background: linear-gradient(-45deg, #ffedd5, #fb923c, #f97316, #ea580c); background-size: 400% 400%; animation: gradientShift 6s ease infinite; }
        .ignite-glass { background: rgba(255, 255, 255, 0.12); border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 10px 30px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.12); backdrop-filter: blur(10px); }
        .ignite-glow { box-shadow: 0 10px 40px rgba(249, 115, 22, 0.35), 0 0 0 1px rgba(249, 115, 22, 0.2); }
        .ignite-btn { background: linear-gradient(135deg, var(--fire-500), var(--fire-700)); color: white !important; box-shadow: 0 10px 30px rgba(249, 115, 22, 0.35); transition: transform 0.2s ease, box-shadow 0.2s ease, background 600ms ease; }
        .ignite-btn:hover { transform: translateY(-2px); box-shadow: 0 16px 40px rgba(249, 115, 22, 0.45); background: linear-gradient(135deg, var(--fire-400), var(--fire-600)); }
        .ignite-text-strong { color: #fff7ed !important; text-shadow: 0 8px 30px rgba(249, 115, 22, 0.35); }
        .tilt-3d { transform-style: preserve-3d; transition: transform 200ms ease, box-shadow 200ms ease; will-change: transform; }
        .tilt-3d > * { transform: translateZ(20px); }
        .search-mode-toggle { transition: all 0.3s ease; }
        .search-mode-toggle.active { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .search-mode-toggle.inactive { background: transparent; color: rgba(255, 255, 255, 0.7); }
        .search-mode-toggle.inactive:hover { color: white; background: rgba(255, 255, 255, 0.1); }
        .deep-mode-active { background: linear-gradient(135deg, #dc2626, #b91c1c) !important; color: white !important; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4) !important; animation: deepModeGlow 2s ease-in-out infinite alternate; }
        @keyframes deepModeGlow { from { box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4); background: linear-gradient(135deg, #dc2626, #b91c1c); } to { box-shadow: 0 4px 25px rgba(220, 38, 38, 0.6); background: linear-gradient(135deg, #b91c1c, #991b1b); } }
        .search-btn-regular { background: #3b82f6 !important; }
        .search-btn-regular:hover { background: #2563eb !important; }
        .search-btn-deep { background: linear-gradient(135deg, #dc2626, #b91c1c) !important; animation: searchBtnDeepGlow 1.5s ease-in-out infinite alternate, heartbeatGlow 2.2s ease-in-out infinite; }
        .search-btn-deep:hover { background: linear-gradient(135deg, #b91c1c, #991b1b) !important; }
        @keyframes searchBtnDeepGlow { from { box-shadow: 0 0 20px rgba(220, 38, 38, 0.5); } to { box-shadow: 0 0 30px rgba(220, 38, 38, 0.8); } }
        @keyframes heartbeatGlow { 0% { filter: brightness(1); box-shadow: 0 0 18px rgba(249, 115, 22, 0.45); } 14% { filter: brightness(1.06); box-shadow: 0 0 28px rgba(249, 115, 22, 0.55); } 28% { filter: brightness(1); box-shadow: 0 0 18px rgba(249, 115, 22, 0.45); } 42% { filter: brightness(1.06); box-shadow: 0 0 32px rgba(249, 115, 22, 0.6); } 70%, 100% { filter: brightness(1); box-shadow: 0 0 18px rgba(249, 115, 22, 0.45); } }
        .search-info-regular { color: rgba(255, 255, 255, 0.8) !important; }
        .search-info-regular .text-blue-300 { color: #93c5fd !important; }
        .search-info-deep { color: rgba(255, 255, 255, 0.9) !important; }
        .search-info-deep .text-blue-300 { color: #fca5a5 !important; }
        .search-shadow { box-shadow: 0 10px 40px rgba(14, 165, 233, 0.15); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .gradient-bg { background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); }
        .stat-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-light text-dark">
    {% csrf_token %}
    <header class="sticky top-0 z-50 bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3 flex flex-col sm:flex-row justify-between items-center gap-3 sm:gap-0">
            <a href="#" class="text-primary font-bold text-xl sm:text-2xl flex items-center">
                <img src="{% static 'fayltop_transparent.svg' %}" alt="FaylTop Logo" class="mr-2 w-10 h-10 sm:w-11 sm:h-11 md:w-12 md:h-12">
                FaylTop.Cloud
            </a>
             <div class="flex items-center space-x-2 sm:space-x-4">
                 <a href="https://t.me/fayltop_bot" class="bg-primary text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center text-sm sm:text-base">
                    <i data-feather="message-circle" class="w-4 h-4 mr-2"></i>
                    FaylTop_Bot
                </a>
                <a href="https://t.me/fayltop_bot?start=auth" class="text-gray-600 hover:text-primary transition hidden md:block">Kirish</a>
                <a href="https://t.me/fayltop_bot?start=register" class="bg-secondary text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-teal-600 transition text-sm sm:text-base">Ro'yxatdan o'tish</a>
            </div>
        </div>
    </header>

    <section id="heroSection" class="relative gradient-bg gradient-animated text-white py-16 md:py-24 overflow-hidden">
        <div class="hero-bg-container" aria-hidden="true">
            <video class="hero-bg-video" autoplay muted loop playsinline poster="{% static 'image_main.png' %}" preload="metadata" onended="this.currentTime=0;this.play();">
                <source src="{% static 'video_main.mp4' %}" type="video/mp4">
            </video>
            <div class="hero-overlay"></div>
        </div>
        <div class="container mx-auto px-4 text-center relative z-10">
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4 sm:mb-6 animate-fadeInUp">FayltopAi fayl qidiruv</h1>
            <p class="text-md sm:text-lg md:text-xl mb-6 sm:mb-10 max-w-3xl mx-auto animate-fadeInUp stagger-1">Sifatli va tayyor ishlardan foydalaning, vaqt va kuchingizni tejang.</p>

            <div class="max-w-4xl mx-auto bg-white rounded-full p-2 search-shadow animate-fadeInUp stagger-2 ignite-glass hover-glass-pop relative z-10">
                <div class="flex flex-col sm:flex-row gap-2 items-center">
                    <div class="flex items-center gap-2 sm:gap-3 w-full sm:flex-1">
                        <input id="searchInput" type="text" placeholder="Qaysi turdagi fayl qidirmoqdasiz?" class="w-full sm:flex-1 px-4 sm:px-6 py-3 rounded-full text-dark focus:outline-none text-sm sm:text-base hover-glow">
                    </div>
                    <button id="searchBtn" class="w-full sm:w-auto flex-1 sm:flex-none bg-primary text-white px-4 sm:px-6 py-3 rounded-full hover:bg-blue-600 transition relative group text-sm sm:text-base ripple hover-scale tilt-3d hover-bloom hover-shadow-xl" title="Qidirish">
                        <span>Qidirish</span>
                    </button>
                </div>
            </div>

            <div class="mt-6 flex justify-center">
                 <div class="ignite-glass rounded-full px-3 py-2 sm:px-4 sm:py-3 flex items-center gap-2 sm:gap-3 select-none">
                     <span class="text-white/80 text-xs sm:text-sm text-center">Chuqurlashtirilgan Qidiruv</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input id="deepToggle" type="checkbox" class="sr-only peer">
                        <div class="w-16 h-8 bg-white/20 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:bg-gradient-to-r peer-checked:from-orange-500 peer-checked:to-orange-700 transition-all duration-500"></div>
                        <span class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full transition-all duration-500 peer-checked:translate-x-8 shadow-md"></span>
                        <span class="ml-3 text-sm text-white/80 peer-checked:text-white">ON</span>
                    </label>
                </div>
            </div>

            <div class="mt-4 sm:mt-6 text-center px-4 animate-fadeInUp stagger-3">
                <p id="searchInfo" class="text-xs sm:text-sm text-white/80">
                    <span class="text-blue-300 font-medium">Oddiy Qidiruv:</span> Faqat fayl nomi bilan qidirish
                </p>
            </div>
        </div>
    </section>

    <section class="py-8 sm:py-12 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-xl sm:text-2xl font-bold mb-6 sm:mb-8 text-center animate-fadeInUp">Top Fayllar</h2>
            <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-8 sm:mb-12">
                </div>

            <div id="paginationContainer" class="flex justify-center mt-6 sm:mt-8 mb-8 sm:mb-12">
                <div id="pagination" class="flex items-center space-x-1 sm:space-x-2">
                    </div>
            </div>
        </div>
    </section>

    <section class="py-8 bg-white">
        <div class="container mx-auto px-4">
            <div class="text-center mb-4">
                <h2 class="text-xl font-semibold">Tayyor mahsulotlardan foydalanish qanday ishlaydi?</h2>
            </div>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-center sm:justify-between gap-4 sm:gap-3 rounded-xl p-3 ignite-glass">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">1</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2">
                        <i data-feather="search" class="w-4 h-4 text-gray-500"></i>
                        <span>Qidiring va tanlang</span>
                    </div>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">2</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2">
                        <i data-feather="credit-card" class="w-4 h-4 text-gray-500"></i>
                        <span>Sotib oling</span>
                    </div>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">3</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2">
                        <i data-feather="download" class="w-4 h-4 text-gray-500"></i>
                        <span>Yuklab oling</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="filePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden ios-modal flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl h-5/6 flex flex-col ios-sheet">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="previewFileName" class="text-lg sm:text-xl font-semibold text-primary"></h3>
                <button onclick="closeFilePreview()" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
             <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <div class="w-full lg:w-7/12 border-b lg:border-b-0 lg:border-r p-4 overflow-auto">
                    <div id="previewImagesContainer" class="space-y-3"></div>
                </div>
                <div class="w-full lg:w-5/12 p-6 overflow-auto">
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Fayl Ma'lumotlari</h4>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Format:</span>
                                <span id="previewFileType" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Hajmi:</span>
                                <span id="previewFileSize" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Ko'rishlar:</span>
                                <span id="previewViews" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Yuklab olishlar:</span>
                                <span id="previewDownloads" class="font-medium"></span>
                            </div>
                        </div>
                    </div>
                    <button id="downloadBtn" onclick="downloadFile()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-blue-600 transition flex items-center justify-center">
                        <i data-feather="download" class="w-5 h-5 mr-2"></i>
                        Telegram orqali yuklab olish
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-2">
                        Yuklab olish uchun Telegram hisobingizga ulaning
                    </p>
                </div>
            </div>
        </div>
    </div>

    <button id="feedbackFab" aria-label="Fikr qoldirish" class="fixed z-50 bottom-5 right-5 w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-xl hover:shadow-2xl hover:scale-105 transition flex items-center justify-center tilt-3d">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor"><path d="M2 5a3 3 0 013-3h14a3 3 0 013 3v9a3 3 0 01-3 3H9.83l-3.41 3.41A1 1 0 015 19.59V17H5a3 3 0 01-3-3V5z"/></svg>
    </button>

    <div id="feedbackModal" class="fixed inset-0 hidden ios-modal z-50 flex items-end sm:items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="w-full sm:max-w-md bg-white rounded-2xl ios-sheet p-4 sm:p-5 relative">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold">Fikr qoldirish</h3>
                <button id="feedbackClose" class="text-gray-500 hover:text-gray-700" aria-label="Yopish">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="feedbackForm" class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ism Familiya</label>
                    <input id="fbFullName" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ismingiz va familiyangiz" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Aloqa (ixtiyoriy)</label>
                    <input id="fbContact" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Telefon, email yoki Telegram">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Xabar</label>
                    <textarea id="fbMessage" rows="4" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Fikringizni yozing" required></textarea>
                </div>
                <button type="submit" class="w-full ignite-btn rounded-lg py-2.5 font-medium">Yuborish</button>
                <p id="fbResult" class="text-sm"></p>
            </form>
        </div>
    </div>

    <script>
        // Javascript code is unchanged as it doesn't affect the layout.
        feather.replace();

        // Global variables
        let currentFileId = null;
        let currentPage = 1;
        let totalPages = 1;
        let allFiles = [];
        let filesPerPage = 12;
        let isSportMode = false;
        let isDeepMode = false;

        // API URLs
        const API_BASE = '{{ MAIN_URL }}';
        const TOP_FILES_API = `${API_BASE}/api/files/api/top-downloads/`;
        const SEARCH_API = `${API_BASE}/api/files/api/search/`;
        const DOWNLOAD_API = `${API_BASE}/api/files/api/`;

        // Ignite Theme Helpers (no indicator text)
        function enableIgniteTheme() {
            const heroSection = document.getElementById('heroSection');
            heroSection.classList.add('ignite-mode');
        }
        function disableIgniteTheme() {
            const heroSection = document.getElementById('heroSection');
            heroSection.classList.remove('ignite-mode');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTopFiles();
            setupSearchFunctionality();
            setupFeedbackUI();
        });

        // Load top downloaded files
        async function loadTopFiles() {
            try {
                const response = await fetch(TOP_FILES_API);
                const data = await response.json();
                allFiles = data.results || [];
                totalPages = Math.ceil(allFiles.length / filesPerPage);
                displayFilesForPage(1);
                generatePagination();
            } catch (error) {
                console.error('Error loading top files:', error);
                displayErrorMessage('Fayllarni yuklashda xatolik yuz berdi');
            }
        }

        // Setup search functionality
        function setupSearchFunctionality() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const deepToggle = document.getElementById('deepToggle') || { checked: false };
            const deepToggleInline = document.getElementById('deepToggleInline');

            // Search button click
            searchBtn.addEventListener('click', () => performSearch());

            // Enter key in input
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Switch toggle(s)
            deepToggleInline && deepToggleInline.addEventListener('change', (e) => setSearchMode(e.target.checked));
            // Backwards-compat for previous switch
            if (document.getElementById('deepToggle')) {
                document.getElementById('deepToggle').addEventListener('change', (e) => setSearchMode(e.target.checked));
            }

            // Initialize from inline checkbox (or legacy)
            setSearchMode(deepToggleInline ? deepToggleInline.checked : deepToggle.checked);
        }

        // Set search mode (regular or deep)
        function setSearchMode(deep) {
            isDeepMode = deep;
            const regularModeBtn = document.getElementById('regularModeBtn');
            const deepModeBtn = document.getElementById('deepModeBtn');
            const searchBtn = document.getElementById('searchBtn');
            const searchInfo = document.getElementById('searchInfo');

            if (deep) {
                // Deep mode active (Ignite mode)
                searchBtn.className = 'w-full sm:w-auto flex-1 sm:flex-none text-white px-4 sm:px-6 py-3 rounded-full transition relative group text-sm sm:text-base ripple hover-scale search-btn-deep ignite-btn';
                searchInfo.className = 'text-xs sm:text-sm search-info-deep';
                searchInfo.innerHTML = '<span class="text-blue-300 font-medium">Chuqurlashtirilgan Qidiruv:</span> Fayl ichidan ham qidirish';
                enableIgniteTheme();
                const dk = document.getElementById('deepKnob');
                if (dk) dk.style.transform = 'translateX(20px)';
            } else {
                // Regular mode active
                searchBtn.className = 'w-full sm:w-auto flex-1 sm:flex-none bg-primary text-white px-4 sm:px-6 py-3 rounded-full hover:bg-blue-600 transition relative group text-sm sm:text-base ripple hover-scale';
                searchInfo.className = 'text-xs sm:text-sm search-info-regular';
                searchInfo.innerHTML = '<span class="text-blue-300 font-medium">Oddiy Qidiruv:</span> Faqat fayl nomi bilan qidirish';
                disableIgniteTheme();
                const dk = document.getElementById('deepKnob');
                if (dk) dk.style.transform = 'translateX(0px)';
            }
        }

        // Perform search
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                // If search is empty, reload top files
                loadTopFiles();
                return;
            }

            try {
                // Show loading state
                const searchBtn = document.getElementById('searchBtn');
                const originalSearchText = searchBtn.innerHTML;

                searchBtn.innerHTML = '<span>Qidirilmoqda...</span>';
                searchBtn.disabled = true;

                // Build search URL with current mode
                const searchUrl = isDeepMode
                    ? `${SEARCH_API}?q=${encodeURIComponent(query)}&deep=true`
                    : `${SEARCH_API}?q=${encodeURIComponent(query)}`;

                const response = await fetch(searchUrl);
                const data = await response.json();
                allFiles = data.results || [];
                totalPages = Math.ceil(allFiles.length / filesPerPage);
                displayFilesForPage(1);
                generatePagination();

                // Show search type indicator
                const searchTypeIndicator = document.getElementById('searchTypeIndicator');
                if (searchTypeIndicator) {
                    searchTypeIndicator.remove();
                }

                const indicator = document.createElement('div');
                indicator.id = 'searchTypeIndicator';
                indicator.className = 'mt-4 text-center';
                indicator.innerHTML = `
                    <p class="text-sm ${isDeepMode ? 'text-red-400' : 'text-blue-600'} font-medium">
                        ${isDeepMode ? '剥 Chuqurlashtirilgan Qidiruv' : '博 Oddiy Qidiruv'} - ${allFiles.length} ta natija topildi
                    </p>
                `;

                const fileGrid = document.getElementById('fileGrid');
                fileGrid.parentNode.insertBefore(indicator, fileGrid);

                // Restore button state
                searchBtn.innerHTML = originalSearchText;
                searchBtn.disabled = false;

            } catch (error) {
                console.error('Error performing search:', error);
                displayErrorMessage('Qidiruvda xatolik yuz berdi');

                // Restore button state on error
                const searchBtn = document.getElementById('searchBtn');
                searchBtn.innerHTML = '<span>Qidirish</span>';
                searchBtn.disabled = false;
            }
        }

        // Display files in grid
        function displayFiles(files) {
            const fileGrid = document.getElementById('fileGrid');

            if (!files || files.length === 0) {
                fileGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-gray-500 text-lg">Hech qanday fayl topilmadi</p>
                    </div>
                `;
                return;
            }

            fileGrid.innerHTML = files.map(file => createFileCard(file)).join('');
            feather.replace();
        }

        // Display files for specific page
        function displayFilesForPage(page) {
            const startIndex = (page - 1) * filesPerPage;
            const endIndex = startIndex + filesPerPage;
            const pageFiles = allFiles.slice(startIndex, endIndex);
            displayFiles(pageFiles);
            currentPage = page;
        }

        // Generate pagination buttons
        function generatePagination() {
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                        return;
                    }

            let paginationHTML = '';

            // Previous button
            if (currentPage > 1) {
                paginationHTML += `
                    <button onclick="changePage(${currentPage - 1})" class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition hover-scale">
                        <i data-feather="chevron-left" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                    </button>
                `;
            } else {
                paginationHTML += `
                    <button disabled class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-400 cursor-not-allowed">
                        <i data-feather="chevron-left" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                    </button>
                `;
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `
                    <button onclick="changePage(1)" class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition text-sm sm:text-base hover-scale">1</button>
                `;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-1 sm:px-2 text-gray-500 text-sm sm:text-base">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHTML += `
                        <button class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg bg-primary text-white text-sm sm:text-base animate-pulse">${i}</button>
                    `;
                } else {
                    paginationHTML += `
                        <button onclick="changePage(${i})" class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition text-sm sm:text-base hover-scale">${i}</button>
                    `;
                }
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-1 sm:px-2 text-gray-500 text-sm sm:text-base">...</span>`;
                }
                paginationHTML += `
                    <button onclick="changePage(${totalPages})" class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition text-sm sm:text-base hover-scale">${totalPages}</button>
                `;
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `
                    <button onclick="changePage(${currentPage + 1})" class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition hover-scale">
                        <i data-feather="chevron-right" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                    </button>
                `;
            } else {
                paginationHTML += `
                    <button disabled class="w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-400 cursor-not-allowed">
                        <i data-feather="chevron-right" class="w-3 h-3 sm:w-4 sm:h-4"></i>
                    </button>
                `;
            }

            pagination.innerHTML = paginationHTML;
            feather.replace();
        }

        // Change page function
        function changePage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                displayFilesForPage(page);
                generatePagination();
                // Scroll to top of file grid
                document.getElementById('fileGrid').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Create file card HTML
        function createFileCard(file) {
            const fileType = getFileType(file.title);
            const fileSize = formatFileSize(file.file_size || 0);
            const iconUrl = getFileIcon(fileType);
            const previewUrl = getFilePreview(file.id);

            return `
                <div class="bg-white rounded-xl p-5 shadow-md card-hover hover-lift hover-bloom hover-shadow-xl cursor-pointer animate-fadeInUp"
                     onclick="showFilePreview('${file.id}', '${escapeHtml(file.title)}', '${fileType}', '${fileSize}', '${file.view_count || 0}', '${file.download_count || 0}', '${previewUrl}')">
                    <div class="flex items-center mb-4">
                        <img src="${iconUrl}" alt="${fileType} Icon" class="w-10 h-10 mr-3 hover-scale">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-primary truncate">${escapeHtml(file.title)}</h3>
                            <p class="text-sm text-gray-500">${fileType} 窶｢ ${fileSize}</p>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500">
                        <div class="flex items-center">
                            <i data-feather="eye" class="w-4 h-4 mr-1"></i>
                            <span>${formatNumber(file.view_count || 0)}</span>
                        </div>
                        <div class="flex items-center">
                            <i data-feather="download" class="w-4 h-4 mr-1"></i>
                            <span>${formatNumber(file.download_count || 0)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Show file preview modal
        function showFilePreview(fileId, name, type, size, views, downloads, previewUrl) {
            currentFileId = fileId;

            document.getElementById('previewFileName').textContent = name;
            document.getElementById('previewFileType').textContent = type;
            document.getElementById('previewFileSize').textContent = size;
            document.getElementById('previewViews').textContent = formatNumber(views);
            document.getElementById('previewDownloads').textContent = formatNumber(downloads);
            loadDocumentImages(fileId);
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => modal.classList.add('open'));
            document.body.style.overflow = 'hidden';

            // Update view count
            updateViewCount(fileId);
        }

        async function loadDocumentImages(productId) {
            try {
                const container = document.getElementById('previewImagesContainer');
                container.innerHTML = '';
                const prod = (allFiles || []).find(p => String(p.id) === String(productId));
                const documentId = prod && (prod.document_id || (prod.document && prod.document.id));
                if (!documentId) {
                    const img = document.createElement('img');
                    img.src = getFilePreview(productId);
                    img.className = 'w-full h-auto rounded-lg shadow-md';
                    container.appendChild(img);
                    return;
                }
                const resp = await fetch(`${API_BASE}/api/files/api/${documentId}/images/`);
                const data = await resp.json();
                if (data && Array.isArray(data.images) && data.images.length) {
                    data.images.forEach(it => {
                        const img = document.createElement('img');
                        img.src = it.url;
                        img.alt = `Page ${it.page}`;
                        img.className = 'w-full h-auto rounded-lg shadow-md';
                        container.appendChild(img);
                    });
                } else {
                    const img = document.createElement('img');
                    img.src = getFilePreview(productId);
                    img.className = 'w-full h-auto rounded-lg shadow-md';
                    container.appendChild(img);
                }
            } catch (e) {
                const container = document.getElementById('previewImagesContainer');
                container.innerHTML = '';
                const img = document.createElement('img');
                img.src = getFilePreview(productId);
                img.className = 'w-full h-auto rounded-lg shadow-md';
                container.appendChild(img);
            }
        }

        // Close file preview modal
        function closeFilePreview() {
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('open');
            // Wait for transition to finish before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 520);
            document.body.style.overflow = 'auto';
            currentFileId = null;
        }

        // Download file (redirect to Telegram bot)
        async function downloadFile() {
            if (!currentFileId) return;

            try {
                // Update download count
                await updateDownloadCount(currentFileId);

                // Redirect to Telegram bot
                window.open('https://t.me/fayltop_bot?start=download_' + currentFileId, '_blank');
                    } catch (error) {
                console.error('Error downloading file:', error);
                // Still redirect to bot even if API call fails
                window.open('https://t.me/fayltop_bot', '_blank');
            }
        }

        // Update view count
        async function updateViewCount(fileId) {
            try {
                await fetch(`${API_BASE}/api/files/api/${fileId}/view/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
            } catch (error) {
                console.error('Error updating view count:', error);
            }
        }

        // Update download count
        async function updateDownloadCount(fileId) {
            try {
                await fetch(`${API_BASE}/api/files/api/${fileId}/download/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
            } catch (error) {
                console.error('Error updating download count:', error);
            }
        }

        // Utility functions
        function getFileType(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const typeMap = {
                'pdf': 'PDF',
                'doc': 'DOC',
                'docx': 'DOCX',
                'xls': 'XLS',
                'xlsx': 'XLSX',
                'ppt': 'PPT',
                'pptx': 'PPTX',
                'zip': 'ZIP',
                'rar': 'RAR',
                'txt': 'TXT'
            };
            return typeMap[extension] || extension.toUpperCase();
        }

        function getFileIcon(fileType) {
            // Create SVG icon with file type suffix
            const svgIcon = createFileTypeIcon(fileType);
            return svgIcon;
        }

        function createFileTypeIcon(fileType) {
            // Create a blue file icon with the file type suffix
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="fileGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#0ea5e9;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect x="8" y="6" width="24" height="28" rx="2" fill="url(#fileGradient)" stroke="#0ea5e9" stroke-width="1"/>
                    <rect x="8" y="6" width="8" height="6" rx="1" fill="#ffffff" opacity="0.9"/>
                    <text x="20" y="26" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="8" font-weight="bold">${fileType}</text>
                </svg>
            `;

            // Use encodeURIComponent instead of btoa to handle Unicode characters
            return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
        }

        function getFilePreview(fileId) {
            return `https://static.photos/document/800x1000/${fileId % 10 + 1}`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }

        function displayErrorMessage(message) {
            const fileGrid = document.getElementById('fileGrid');
            fileGrid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <p class="text-red-500 text-lg">${message}</p>
                </div>
            `;
        }

        // Add subtle 3D tilt on hover for interactive elements
        document.addEventListener('mousemove', function(e) {
            document.querySelectorAll('.tilt-3d').forEach(function(el) {
                const rect = el.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = -((y - centerY) / centerY) * 6;
                const rotateY = ((x - centerX) / centerX) * 6;
                el.style.transform = `perspective(700px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
        });
        document.addEventListener('mouseout', function(e) {
            if (e.target.classList && e.target.classList.contains('tilt-3d')) {
                e.target.style.transform = 'perspective(700px) rotateX(0deg) rotateY(0deg)';
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFilePreview();
            }
        });

        // Close modal on outside click
        document.getElementById('filePreviewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFilePreview();
            }
        });

        // Feedback UI
        function setupFeedbackUI() {
            const fab = document.getElementById('feedbackFab');
            const modal = document.getElementById('feedbackModal');
            const closeBtn = document.getElementById('feedbackClose');
            const form = document.getElementById('feedbackForm');
            const result = document.getElementById('fbResult');

            fab.addEventListener('click', () => {
                modal.classList.remove('hidden');
                requestAnimationFrame(() => modal.classList.add('open'));
            });
            closeBtn.addEventListener('click', () => hideFeedbackModal());
            modal.addEventListener('click', (e) => { if (e.target === modal) hideFeedbackModal(); });

            function hideFeedbackModal() {
                modal.classList.remove('open');
                setTimeout(() => modal.classList.add('hidden'), 520);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                result.textContent = '';
                const payload = {
                    full_name: document.getElementById('fbFullName').value.trim(),
                    contact: document.getElementById('fbContact').value.trim(),
                    message: document.getElementById('fbMessage').value.trim()
                };
                try {
                    const resp = await fetch(`${API_BASE}/api/feedback/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    result.className = 'text-sm text-green-600';
                    result.textContent = 'Rahmat! Fikringiz yuborildi.';
                    form.reset();
                    setTimeout(() => hideFeedbackModal(), 800);
                } catch (err) {
                    result.className = 'text-sm text-red-600';
                    result.textContent = 'Yuborishda xatolik. Keyinroq urinib ko窶腕ing.';
                }
            });
        }
    </script>
</body>
</html>