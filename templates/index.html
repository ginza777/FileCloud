{% load static %}
<!DOCTYPE html>
<html lang="uz" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FayltopAi fayl qidiruv</title>
    <link rel="icon" type="image/x-icon" href="{% static 'icon.png' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                screens: { 'xs': '475px', 'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px', '2xl': '1536px' },
                extend: {
                    colors: { primary: '#0ea5e9', secondary: '#06b6d4', dark: '#0f172a', light: '#f8fafc' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; color: #0f172a; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeInUp { animation: fadeInUp 0.7s ease-out forwards; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; }
        .ios-modal { opacity: 0; backdrop-filter: blur(0px); transition: opacity 420ms ease, backdrop-filter 420ms ease; }
        .ios-modal.open { opacity: 1; backdrop-filter: blur(8px); }
        .ios-sheet { transform: translateY(24px) scale(0.98); opacity: 0; transition: transform 520ms cubic-bezier(.22,.61,.36,1), opacity 380ms ease; }
        .ios-modal.open .ios-sheet { transform: translateY(0) scale(1); opacity: 1; }
    </style>
</head>
<body>
    {% csrf_token %}

    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <a href="/" class="flex items-center gap-2 text-xl font-bold text-primary">
                    <img src="{% static 'fayltop_transparent.svg' %}" alt="FaylTop Logo" class="w-9 h-9 sm:w-10 sm:h-10">
                    <span class="hidden sm:inline">FaylTop.Cloud</span>
                    <span class="sm:hidden">FaylTop</span>
                </a>
                <a href="https://t.me/fayltopbot" target="_blank" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition flex items-center gap-2 text-sm font-medium">
                    <i data-feather="message-circle" class="w-4 h-4"></i>
                    <span class="hidden xs:inline">FaylTop Bot</span>
                    <span class="xs:hidden">Bot</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <section class="relative text-white py-20 md:py-28 overflow-hidden bg-sky-500">
             <div class="absolute inset-0 z-0">
                <video class="w-full h-full object-cover" autoplay muted loop playsinline poster="{% static 'image_main.png' %}">
                    <source src="{% static 'video_main.mp4' %}" type="video/mp4">
                </video>
                <div class="absolute inset-0 bg-black/50"></div>
            </div>
            <div class="container mx-auto px-4 text-center relative z-10">
                <h1 class="text-4xl md:text-6xl font-extrabold mb-4 animate-fadeInUp" style="animation-delay: 0.1s;">FayltopAi fayl qidiruv</h1>
                <p class="text-lg md:text-xl mb-8 max-w-3xl mx-auto text-white/90 animate-fadeInUp" style="animation-delay: 0.2s;">Sifatli va tayyor ishlardan foydalaning, vaqt va kuchingizni tejang.</p>

                <div class="max-w-3xl mx-auto bg-white/20 backdrop-blur-md rounded-full p-2 animate-fadeInUp" style="animation-delay: 0.3s;">
                    <form id="searchForm" class="flex flex-col sm:flex-row gap-2" onsubmit="performSearch(event)">
                        <input id="searchInput" type="text" placeholder="Qaysi turdagi fayl qidirmoqdasiz?" class="w-full px-6 py-3 rounded-full text-dark focus:outline-none focus:ring-2 focus:ring-sky-400 text-base">
                        <button id="searchBtn" type="submit" class="w-full sm:w-auto bg-primary text-white px-8 py-3 rounded-full hover:bg-sky-600 transition font-semibold text-base">Qidirish</button>
                    </form>
                </div>

                <div class="mt-6 flex justify-center items-center gap-4 animate-fadeInUp" style="animation-delay: 0.4s;">
                    <label for="deepToggle" class="flex items-center gap-3 cursor-pointer select-none">
                        <span class="text-sm text-white/80">Chuqurlashtirilgan Qidiruv</span>
                        <div class="relative">
                            <input id="deepToggle" type="checkbox" class="sr-only peer">
                            <div class="w-14 h-8 bg-white/30 rounded-full peer-checked:bg-gradient-to-r peer-checked:from-orange-500 peer-checked:to-red-600 transition-colors"></div>
                            <div class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full transition-transform peer-checked:translate-x-6"></div>
                        </div>
                    </label>
                </div>
                 <p id="searchInfo" class="mt-4 text-sm text-white/90 animate-fadeInUp" style="animation-delay: 0.5s;"><span class="font-semibold text-sky-300">Oddiy Qidiruv:</span> Faqat fayl nomi bilan qidirish</p>
            </div>
        </section>

        <section class="py-12 sm:py-16">
            <div class="container mx-auto px-4">
                <h2 id="fileSectionTitle" class="text-3xl font-bold mb-8 text-center">Top Fayllar</h2>
                
                <div id="fileListContainer">
                    <div id="skeletonLoader" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for i in "123456" %}
                        <div class="bg-white rounded-xl p-5 shadow-md">
                            <div class="flex items-center mb-4 gap-4">
                                <div class="w-12 h-12 rounded-lg shimmer"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 shimmer"></div>
                                    <div class="h-3 bg-gray-200 rounded w-1/2 shimmer"></div>
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <div class="h-4 bg-gray-200 rounded w-1/4 shimmer"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/4 shimmer"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div id="errorMessage" class="hidden text-center bg-red-50 border-l-4 border-red-400 text-red-700 p-6 rounded-lg max-w-2xl mx-auto">
                        <div class="flex items-center justify-center gap-4">
                            <i data-feather="alert-triangle" class="w-8 h-8"></i>
                            <div>
                                <p class="font-bold text-lg">Xatolik yuz berdi</p>
                                <p class="text-base">Fayllarni yuklab bo'lmadi. Iltimos, internet aloqasini tekshiring.</p>
                            </div>
                        </div>
                    </div>

                    <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
                </div>

                <div id="paginationContainer" class="flex justify-center mt-12"></div>
            </div>
        </section>
    </main>

    <section class="py-8 bg-white">
        <div class="container mx-auto px-4">
            <div class="text-center mb-4">
                <h2 class="text-xl font-semibold">Tayyor mahsulotlardan foydalanish qanday ishlaydi?</h2>
            </div>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-center sm:justify-between gap-4 sm:gap-3 rounded-xl p-3 ignite-glass">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">1</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2">
                        <i data-feather="search" class="w-4 h-4 text-gray-500"></i>
                        <span>Qidiring va tanlang</span>
                    </div>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">2</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2">
                        <i data-feather="credit-card" class="w-4 h-4 text-gray-500"></i>
                        <span>Sotib oling</span>
                    </div>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">3</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2">
                        <i data-feather="download" class="w-4 h-4 text-gray-500"></i>
                        <span>Yuklab oling</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="filePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden ios-modal flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl h-5/6 flex flex-col ios-sheet">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="previewFileName" class="text-lg sm:text-xl font-semibold text-primary truncate pr-2"></h3>
                <button onclick="closeFilePreview()" class="text-gray-500 hover:text-gray-700 flex-shrink-0">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
             <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <div id="previewImagesContainer" class="w-full lg:w-7/12 border-b lg:border-b-0 lg:border-r p-4 overflow-auto space-y-3">
                    </div>
                <div class="w-full lg:w-5/12 p-6 overflow-auto">
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Fayl Ma'lumotlari</h4>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between"><span>Format:</span><span id="previewFileType" class="font-medium"></span></div>
                            <div class="flex justify-between"><span>Hajmi:</span><span id="previewFileSize" class="font-medium"></span></div>
                            <div class="flex justify-between"><span>Ko'rishlar:</span><span id="previewViews" class="font-medium"></span></div>
                            <div class="flex justify-between"><span>Yuklab olishlar:</span><span id="previewDownloads" class="font-medium"></span></div>
                        </div>
                    </div>
                    <button id="downloadBtn" onclick="downloadFile()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-sky-600 transition flex items-center justify-center text-base font-semibold">
                        <i data-feather="download" class="w-5 h-5 mr-2"></i>
                        <span>Telegram orqali yuklab olish</span>
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-2">Yuklab olish uchun Telegram botimizdan foydalaning</p>
                </div>
            </div>
        </div>
    </div>

    <button id="feedbackFab" aria-label="Fikr qoldirish" class="fixed z-50 bottom-5 right-5 w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-xl hover:shadow-2xl hover:scale-105 transition flex items-center justify-center tilt-3d">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor"><path d="M2 5a3 3 0 013-3h14a3 3 0 013 3v9a3 3 0 01-3 3H9.83l-3.41 3.41A1 1 0 015 19.59V17H5a3 3 0 01-3-3V5z"/></svg>
    </button>

    <div id="feedbackModal" class="fixed inset-0 hidden ios-modal z-50 flex items-end sm:items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="w-full sm:max-w-md bg-white rounded-2xl ios-sheet p-4 sm:p-5 relative">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold">Fikr qoldirish</h3>
                <button id="feedbackClose" class="text-gray-500 hover:text-gray-700" aria-label="Yopish">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="feedbackForm" class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ism Familiya</label>
                    <input id="fbFullName" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ismingiz va familiyangiz" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Aloqa (ixtiyoriy)</label>
                    <input id="fbContact" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Telefon, email yoki Telegram">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Xabar</label>
                    <textarea id="fbMessage" rows="4" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Fikringizni yozing" required></textarea>
                </div>
                <button type="submit" class="w-full ignite-btn rounded-lg py-2.5 font-medium">Yuborish</button>
                <p id="fbResult" class="text-sm"></p>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        
        // GLOBAL VARIABLES & CONFIG
        const API_BASE = '{{ MAIN_URL }}';
        const TOP_FILES_API = `${API_BASE}/api/files/api/top-downloads/`;
        const SEARCH_API = `${API_BASE}/api/files/api/search/`;
        const filesPerPage = 9;
        let isDeepMode = false;
        let currentFileId = null;

        // DOM ELEMENTS
        const fileGrid = document.getElementById('fileGrid');
        const skeletonLoader = document.getElementById('skeletonLoader');
        const errorMessage = document.getElementById('errorMessage');
        const fileSectionTitle = document.getElementById('fileSectionTitle');

        // --- UI STATE MANAGEMENT ---
        function showLoadingState() {
            skeletonLoader.classList.remove('hidden');
            fileGrid.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showContentState() {
            fileGrid.classList.remove('hidden');
            skeletonLoader.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showErrorState() {
            errorMessage.classList.remove('hidden');
            skeletonLoader.classList.add('hidden');
            fileGrid.classList.add('hidden');
        }

        // --- API & DATA FETCHING ---
        async function fetchData(url) {
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error);
                    if (attempt === 3) throw error;
                    await new Promise(res => setTimeout(res, 1000 * attempt));
                }
            }
        }

        async function loadTopFiles(page = 1) {
            showLoadingState();
            fileSectionTitle.textContent = "Top Fayllar";
            try {
                const data = await fetchData(`${TOP_FILES_API}?page=${page}&page_size=${filesPerPage}`);
                if (data && data.results) {
                    displayFiles(data.results);
                    generatePagination(data.total_pages, page, loadTopFiles);
                    showContentState();
                } else {
                    showErrorState();
                }
            } catch (error) {
                console.error('Failed to load top files:', error);
                showErrorState();
            }
        }

        window.performSearch = async function(event, page = 1) {
            if (event) event.preventDefault();
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                loadTopFiles();
                return;
            }

            showLoadingState();
            fileSectionTitle.textContent = `"${query}" uchun natijalar`;
            const searchUrl = `${SEARCH_API}?q=${encodeURIComponent(query)}&deep=${isDeepMode}&page=${page}&page_size=${filesPerPage}`;
            
            try {
                const data = await fetchData(searchUrl);
                if (data && data.results) {
                    displayFiles(data.results);
                    const searchFn = (p) => performSearch(null, p);
                    generatePagination(data.total_pages, page, searchFn);
                    showContentState();
                } else {
                     showErrorState();
                }
            } catch (error) {
                console.error('Failed to perform search:', error);
                showErrorState();
            }
        }
        
        // --- RENDERING ---
        function displayFiles(files) {
            if (files.length === 0) {
                fileGrid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500 text-lg">Hech qanday fayl topilmadi</div>`;
                return;
            }
            fileGrid.innerHTML = files.map(file => createFileCard(file)).join('');
            feather.replace();
        }
        
        function createFileCard(file) {
            const fileType = file.title.split('.').pop().toUpperCase() || 'FILE';
            const fileSize = file.file_size ? `${(file.file_size / 1024 / 1024).toFixed(2)} MB` : 'N/A';
            const escapedTitle = file.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');

            return `
                <div class="bg-white rounded-xl p-5 shadow-sm hover:shadow-lg transition-shadow duration-300 cursor-pointer" 
                     onclick="showFilePreview('${file.id}', '${escapedTitle}', '${fileType}', '${fileSize}', '${file.view_count || 0}', '${file.download_count || 0}')">
                    <div class="flex items-center mb-4 gap-4">
                        <div class="w-12 h-12 bg-sky-100 text-sky-600 font-bold text-sm flex items-center justify-center rounded-lg flex-shrink-0">${fileType}</div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-gray-800 truncate">${file.title}</h3>
                            <p class="text-sm text-gray-500">${fileSize}</p>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500">
                        <div class="flex items-center gap-1.5"><i data-feather="eye" class="w-4 h-4"></i><span>${file.view_count || 0}</span></div>
                        <div class="flex items-center gap-1.5"><i data-feather="download" class="w-4 h-4"></i><span>${file.download_count || 0}</span></div>
                    </div>
                </div>
            `;
        }

        function generatePagination(totalPages, currentPage, pageChangeFn) {
            const container = document.getElementById('paginationContainer');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div class="flex items-center space-x-2">';
            const createButton = (page, content, disabled = false, active = false) => {
                const baseClasses = 'w-10 h-10 flex items-center justify-center rounded-lg border';
                let stateClasses = 'border-gray-300 text-gray-600 hover:bg-gray-50';
                if (disabled) stateClasses = 'border-gray-200 text-gray-400 cursor-not-allowed';
                if (active) stateClasses = 'bg-primary text-white border-primary cursor-default';
                const button = document.createElement('button');
                button.innerHTML = content;
                button.className = `${baseClasses} ${stateClasses}`;
                if (!disabled && !active) {
                    button.onclick = () => pageChangeFn(page);
                }
                return button.outerHTML;
            };

            html += createButton(currentPage - 1, '<i data-feather="chevron-left" class="w-4 h-4"></i>', currentPage === 1);

            // Logic for page numbers (e.g., 1 ... 4 5 6 ... 10)
            const pagesToShow = [];
            pagesToShow.push(1);
            if (currentPage > 3) pagesToShow.push('...');
            for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                pagesToShow.push(i);
            }
            if (currentPage < totalPages - 2) pagesToShow.push('...');
            if (totalPages > 1) pagesToShow.push(totalPages);
            
            const uniquePages = [...new Set(pagesToShow)];

            uniquePages.forEach(page => {
                if(page === '...') {
                    html += '<span class="px-2 text-gray-500">...</span>';
                } else {
                    html += createButton(page, page, false, page === currentPage);
                }
            });

            html += createButton(currentPage + 1, '<i data-feather="chevron-right" class="w-4 h-4"></i>', currentPage === totalPages);
            html += '</div>';

            container.innerHTML = html;
            feather.replace();
        }
        
        // --- MODAL & INTERACTIONS ---
        window.showFilePreview = function(fileId, name, type, size, views, downloads) {
            currentFileId = fileId;
            document.getElementById('previewFileName').textContent = name;
            document.getElementById('previewFileType').textContent = type;
            document.getElementById('previewFileSize').textContent = size;
            document.getElementById('previewViews').textContent = views;
            document.getElementById('previewDownloads').textContent = downloads;
            
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => modal.classList.add('open'));
            document.body.style.overflow = 'hidden';
        }

        window.closeFilePreview = function() {
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('open');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 520);
            document.body.style.overflow = 'auto';
            currentFileId = null;
        }

        window.downloadFile = function() {
            if (!currentFileId) return;
            window.open(`https://t.me/fayltopbot?start=download_${currentFileId}`, '_blank');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('deepToggle').addEventListener('change', (e) => {
            isDeepMode = e.target.checked;
            const searchInfo = document.getElementById('searchInfo');
            if(isDeepMode) {
                searchInfo.innerHTML = '<span class="font-semibold text-orange-300">Chuqurlashtirilgan Qidiruv:</span> Fayl ichidan ham qidirish';
            } else {
                searchInfo.innerHTML = '<span class="font-semibold text-sky-300">Oddiy Qidiruv:</span> Faqat fayl nomi bilan qidirish';
            }
        });

        // Close modal on escape key or outside click
        document.addEventListener('keydown', (e) => e.key === 'Escape' && closeFilePreview());
        document.getElementById('filePreviewModal').addEventListener('click', (e) => e.target === e.currentTarget && closeFilePreview());

        // INITIAL LOAD
        loadTopFiles();
    });
    </script>
        const DOWNLOAD_API = `${API_BASE}/api/files/api/`;

        // Ignite Theme Helpers (no indicator text)
        function enableIgniteTheme() {
            const heroSection = document.getElementById('heroSection');
            heroSection.classList.add('ignite-mode');
        }
        function disableIgniteTheme() {
            const heroSection = document.getElementById('heroSection');
            heroSection.classList.remove('ignite-mode');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTopFiles();
            setupSearchFunctionality();
            setupFeedbackUI();
        });

        // Retry mechanism for API calls
        async function retryApiCall(apiCall, maxRetries = 3, delay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await apiCall();
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        throw error; // Last attempt failed
                    }
                    
                    // Wait before retry with exponential backoff
                    const waitTime = delay * Math.pow(2, attempt - 1);
                    console.log(`Retrying in ${waitTime}ms...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }

        // Load top downloaded files with pagination and retry
        async function loadTopFiles(page = 1) {
            try {
                const apiCall = async () => {
                    const response = await fetch(`${TOP_FILES_API}?page=${page}&page_size=${filesPerPage}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                };

                const data = await retryApiCall(apiCall);
                
                if (data.results) {
                    allFiles = data.results;
                    totalPages = data.total_pages || Math.ceil(data.total / filesPerPage) || 1;
                    currentPage = data.page || 1;
                    displayFiles(allFiles);
                    generatePagination();
                } else {
                    displayErrorMessage('Fayllarni yuklashda xatolik yuz berdi');
                }
            } catch (error) {
                console.error('Error loading top files after retries:', error);
                displayErrorMessage('Fayllarni yuklashda xatolik yuz berdi. Internet aloqasini tekshiring.');
            }
        }

        // Setup search functionality
        function setupSearchFunctionality() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const deepToggle = document.getElementById('deepToggle') || { checked: false };
            const deepToggleInline = document.getElementById('deepToggleInline');

            // Search button click
            searchBtn.addEventListener('click', () => performSearch());

            // Enter key in input
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Switch toggle(s)
            deepToggleInline && deepToggleInline.addEventListener('change', (e) => setSearchMode(e.target.checked));
            // Backwards-compat for previous switch
            if (document.getElementById('deepToggle')) {
                document.getElementById('deepToggle').addEventListener('change', (e) => setSearchMode(e.target.checked));
            }

            // Initialize from inline checkbox (or legacy)
            setSearchMode(deepToggleInline ? deepToggleInline.checked : deepToggle.checked);
        }

        // Set search mode (regular or deep)
        function setSearchMode(deep) {
            isDeepMode = deep;
            const regularModeBtn = document.getElementById('regularModeBtn');
            const deepModeBtn = document.getElementById('deepModeBtn');
            const searchBtn = document.getElementById('searchBtn');
            const searchInfo = document.getElementById('searchInfo');

            if (deep) {
                // Deep mode active (Ignite mode)
                searchBtn.className = 'w-full sm:w-auto flex-1 sm:flex-none text-white px-4 sm:px-6 py-3 rounded-full transition relative group text-sm sm:text-base ripple hover-scale search-btn-deep ignite-btn';
                searchInfo.className = 'text-xs sm:text-sm search-info-deep';
                searchInfo.innerHTML = '<span class="text-blue-300 font-medium">Chuqurlashtirilgan Qidiruv:</span> Fayl ichidan ham qidirish';
                enableIgniteTheme();
                const dk = document.getElementById('deepKnob');
                if (dk) dk.style.transform = 'translateX(20px)';
            } else {
                // Regular mode active
                searchBtn.className = 'w-full sm:w-auto flex-1 sm:flex-none bg-primary text-white px-4 sm:px-6 py-3 rounded-full hover:bg-blue-600 transition relative group text-sm sm:text-base ripple hover-scale';
                searchInfo.className = 'text-xs sm:text-sm search-info-regular';
                searchInfo.innerHTML = '<span class="text-blue-300 font-medium">Oddiy Qidiruv:</span> Faqat fayl nomi bilan qidirish';
                disableIgniteTheme();
                const dk = document.getElementById('deepKnob');
                if (dk) dk.style.transform = 'translateX(0px)';
            }
        }

        // Perform search with pagination and retry
        async function performSearch(page = 1) {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                // If search is empty, reload top files
                loadTopFiles();
                return;
            }

            try {
                // Show loading state
                const searchBtn = document.getElementById('searchBtn');
                const originalSearchText = searchBtn.innerHTML;

                searchBtn.innerHTML = '<span>Qidirilmoqda...</span>';
                searchBtn.disabled = true;

                const apiCall = async () => {
                    // Build search URL with current mode and pagination
                    const searchUrl = isDeepMode
                        ? `${SEARCH_API}?q=${encodeURIComponent(query)}&deep=true&page=${page}&page_size=${filesPerPage}`
                        : `${SEARCH_API}?q=${encodeURIComponent(query)}&page=${page}&page_size=${filesPerPage}`;

                    const response = await fetch(searchUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return await response.json();
                };

                const data = await retryApiCall(apiCall);
                
                if (data.results) {
                    allFiles = data.results;
                    totalPages = data.total_pages || Math.ceil(data.total / filesPerPage) || 1;
                    currentPage = data.page || 1;
                    displayFiles(allFiles);
                    generatePagination();

                // Show search type indicator
                const searchTypeIndicator = document.getElementById('searchTypeIndicator');
                if (searchTypeIndicator) {
                    searchTypeIndicator.remove();
                }

                const indicator = document.createElement('div');
                indicator.id = 'searchTypeIndicator';
                indicator.className = 'mt-4 text-center';
                indicator.innerHTML = `
                    <p class="text-sm ${isDeepMode ? 'text-red-400' : 'text-blue-600'} font-medium">
                        ${isDeepMode ? 'Chuqurlashtirilgan Qidiruv' : 'Oddiy Qidiruv'} - ${allFiles.length} ta natija topildi
                    </p>
                `;

                    const fileGrid = document.getElementById('fileGrid');
                    fileGrid.parentNode.insertBefore(indicator, fileGrid);
                } else {
                    displayErrorMessage('Qidiruvda xatolik yuz berdi');
                }

                // Restore button state
                searchBtn.innerHTML = originalSearchText;
                searchBtn.disabled = false;

            } catch (error) {
                console.error('Error performing search after retries:', error);
                displayErrorMessage('Qidiruvda xatolik yuz berdi. Internet aloqasini tekshiring.');

                // Restore button state on error
                const searchBtn = document.getElementById('searchBtn');
                searchBtn.innerHTML = '<span>Qidirish</span>';
                searchBtn.disabled = false;
            }
        }

        // Display files in grid
        function displayFiles(files) {
            const fileGrid = document.getElementById('fileGrid');

            if (!files || files.length === 0) {
                fileGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-gray-500 text-lg">Hech qanday fayl topilmadi</p>
                    </div>
                `;
                return;
            }

            fileGrid.innerHTML = files.map(file => createFileCard(file)).join('');
            feather.replace();
        }

        // Display files for specific page (deprecated - now using API pagination)
        function displayFilesForPage(page) {
            const startIndex = (page - 1) * filesPerPage;
            const endIndex = startIndex + filesPerPage;
            const pageFiles = allFiles.slice(startIndex, endIndex);
            displayFiles(pageFiles);
            currentPage = page;
        }

        // Generate pagination buttons
        function generatePagination() {
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                        return;
                    }

            let paginationHTML = '';

            // Previous button
            if (currentPage > 1) {
                paginationHTML += `
                    <button onclick="changePage(${currentPage - 1})" class="w-7 h-7 xs:w-8 xs:h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition hover-scale">
                        <i data-feather="chevron-left" class="w-2.5 h-2.5 xs:w-3 xs:h-3 sm:w-4 sm:h-4"></i>
                    </button>
                `;
            } else {
                paginationHTML += `
                    <button disabled class="w-7 h-7 xs:w-8 xs:h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-400 cursor-not-allowed">
                        <i data-feather="chevron-left" class="w-2.5 h-2.5 xs:w-3 xs:h-3 sm:w-4 sm:h-4"></i>
                    </button>
                `;
            }

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `
                    <button onclick="changePage(1)" class="w-7 h-7 xs:w-8 xs:h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition text-xs xs:text-sm sm:text-base hover-scale">1</button>
                `;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-0.5 xs:px-1 sm:px-2 text-gray-500 text-xs xs:text-sm sm:text-base">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHTML += `
                        <button class="w-7 h-7 xs:w-8 xs:h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg bg-primary text-white text-xs xs:text-sm sm:text-base animate-pulse">${i}</button>
                    `;
                } else {
                    paginationHTML += `
                        <button onclick="changePage(${i})" class="w-7 h-7 xs:w-8 xs:h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition text-xs xs:text-sm sm:text-base hover-scale">${i}</button>
                    `;
                }
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-0.5 xs:px-1 sm:px-2 text-gray-500 text-xs xs:text-sm sm:text-base">...</span>`;
                }
                paginationHTML += `
                    <button onclick="changePage(${totalPages})" class="w-7 h-7 xs:w-8 xs:h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition text-xs xs:text-sm sm:text-base hover-scale">${totalPages}</button>
                `;
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `
                    <button onclick="changePage(${currentPage + 1})" class="w-7 h-7 xs:w-8 xs:h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-50 transition hover-scale">
                        <i data-feather="chevron-right" class="w-2.5 h-2.5 xs:w-3 xs:h-3 sm:w-4 sm:h-4"></i>
                    </button>
                `;
            } else {
                paginationHTML += `
                    <button disabled class="w-7 h-7 xs:w-8 xs:h-8 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border border-gray-300 text-gray-400 cursor-not-allowed">
                        <i data-feather="chevron-right" class="w-2.5 h-2.5 xs:w-3 xs:h-3 sm:w-4 sm:h-4"></i>
                    </button>
                `;
            }

            pagination.innerHTML = paginationHTML;
            feather.replace();
        }

        // Change page function
        function changePage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                const query = document.getElementById('searchInput').value.trim();
                if (query) {
                    // If there's a search query, perform search with new page
                    performSearch(page);
                } else {
                    // If no search query, load top files with new page
                    loadTopFiles(page);
                }
                // Scroll to top of file grid
                document.getElementById('fileGrid').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Create file card HTML
        function createFileCard(file) {
            const fileType = getFileType(file.title);
            const fileSize = formatFileSize(file.file_size || 0);
            const iconUrl = getFileIcon(fileType);
            const previewUrl = getFilePreview(file.id);

            return `
                <div class="bg-white rounded-xl p-5 shadow-md card-hover hover-lift hover-bloom hover-shadow-xl cursor-pointer animate-fadeInUp"
                     onclick="showFilePreview('${file.id}', '${escapeHtml(file.title)}', '${fileType}', '${fileSize}', '${file.view_count || 0}', '${file.download_count || 0}', '${previewUrl}')">
                    <div class="flex items-center mb-4">
                        <img src="${iconUrl}" alt="${fileType} Icon" class="w-10 h-10 mr-3 hover-scale">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-primary truncate">${escapeHtml(file.title)}</h3>
                            <p class="text-sm text-gray-500">${fileType} 窶｢ ${fileSize}</p>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500">
                        <div class="flex items-center">
                            <i data-feather="eye" class="w-4 h-4 mr-1"></i>
                            <span>${formatNumber(file.view_count || 0)}</span>
                        </div>
                        <div class="flex items-center">
                            <i data-feather="download" class="w-4 h-4 mr-1"></i>
                            <span>${formatNumber(file.download_count || 0)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Show file preview modal
        function showFilePreview(fileId, name, type, size, views, downloads, previewUrl) {
            currentFileId = fileId;

            document.getElementById('previewFileName').textContent = name;
            document.getElementById('previewFileType').textContent = type;
            document.getElementById('previewFileSize').textContent = size;
            document.getElementById('previewViews').textContent = formatNumber(views);
            document.getElementById('previewDownloads').textContent = formatNumber(downloads);
            loadDocumentImages(fileId);
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => modal.classList.add('open'));
            document.body.style.overflow = 'hidden';

            // Update view count
            updateViewCount(fileId);
        }

        async function loadDocumentImages(productId) {
            try {
                const container = document.getElementById('previewImagesContainer');
                container.innerHTML = '';
                const prod = (allFiles || []).find(p => String(p.id) === String(productId));
                const documentId = prod && (prod.document_id || (prod.document && prod.document.id));
                if (!documentId) {
                    const img = document.createElement('img');
                    img.src = getFilePreview(productId);
                    img.className = 'w-full h-auto rounded-lg shadow-md';
                    container.appendChild(img);
                    return;
                }
                const resp = await fetch(`${API_BASE}/api/files/api/${documentId}/images/`);
                const data = await resp.json();
                if (data && Array.isArray(data.images) && data.images.length) {
                    data.images.forEach(it => {
                        const img = document.createElement('img');
                        img.src = it.url;
                        img.alt = `Page ${it.page}`;
                        img.className = 'w-full h-auto rounded-lg shadow-md';
                        container.appendChild(img);
                    });
                } else {
                    const img = document.createElement('img');
                    img.src = getFilePreview(productId);
                    img.className = 'w-full h-auto rounded-lg shadow-md';
                    container.appendChild(img);
                }
            } catch (e) {
                const container = document.getElementById('previewImagesContainer');
                container.innerHTML = '';
                const img = document.createElement('img');
                img.src = getFilePreview(productId);
                img.className = 'w-full h-auto rounded-lg shadow-md';
                container.appendChild(img);
            }
        }

        // Close file preview modal
        function closeFilePreview() {
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('open');
            // Wait for transition to finish before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 520);
            document.body.style.overflow = 'auto';
            currentFileId = null;
        }

        // Download file (redirect to Telegram bot)
        async function downloadFile() {
            if (!currentFileId) return;

            try {
                // Update download count
                await updateDownloadCount(currentFileId);

                // Redirect to Telegram bot
                window.open('https://t.me/fayltopbot?start=download_' + currentFileId, '_blank');
                    } catch (error) {
                console.error('Error downloading file:', error);
                // Still redirect to bot even if API call fails
                window.open('https://t.me/fayltopbot', '_blank');
            }
        }

        // Update view count
        async function updateViewCount(fileId) {
            try {
                await fetch(`${API_BASE}/api/files/api/${fileId}/view/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
            } catch (error) {
                console.error('Error updating view count:', error);
            }
        }

        // Update download count
        async function updateDownloadCount(fileId) {
            try {
                await fetch(`${API_BASE}/api/files/api/${fileId}/download/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
            } catch (error) {
                console.error('Error updating download count:', error);
            }
        }

        // Utility functions
        function getFileType(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const typeMap = {
                'pdf': 'PDF',
                'doc': 'DOC',
                'docx': 'DOCX',
                'xls': 'XLS',
                'xlsx': 'XLSX',
                'ppt': 'PPT',
                'pptx': 'PPTX',
                'zip': 'ZIP',
                'rar': 'RAR',
                'txt': 'TXT'
            };
            return typeMap[extension] || extension.toUpperCase();
        }

        function getFileIcon(fileType) {
            // Create SVG icon with file type suffix
            const svgIcon = createFileTypeIcon(fileType);
            return svgIcon;
        }

        function createFileTypeIcon(fileType) {
            // Create a blue file icon with the file type suffix
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="fileGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#0ea5e9;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect x="8" y="6" width="24" height="28" rx="2" fill="url(#fileGradient)" stroke="#0ea5e9" stroke-width="1"/>
                    <rect x="8" y="6" width="8" height="6" rx="1" fill="#ffffff" opacity="0.9"/>
                    <text x="20" y="26" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="8" font-weight="bold">${fileType}</text>
                </svg>
            `;

            // Use encodeURIComponent instead of btoa to handle Unicode characters
            return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
        }

        function getFilePreview(fileId) {
            return `https://static.photos/document/800x1000/${fileId % 10 + 1}`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }

        function displayErrorMessage(message) {
            const fileGrid = document.getElementById('fileGrid');
            fileGrid.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <p class="text-red-500 text-lg">${message}</p>
                </div>
            `;
        }

        // Add subtle 3D tilt on hover for interactive elements
        document.addEventListener('mousemove', function(e) {
            document.querySelectorAll('.tilt-3d').forEach(function(el) {
                const rect = el.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = -((y - centerY) / centerY) * 6;
                const rotateY = ((x - centerX) / centerX) * 6;
                el.style.transform = `perspective(700px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
        });
        document.addEventListener('mouseout', function(e) {
            if (e.target.classList && e.target.classList.contains('tilt-3d')) {
                e.target.style.transform = 'perspective(700px) rotateX(0deg) rotateY(0deg)';
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeFilePreview();
            }
        });

        // Close modal on outside click
        document.getElementById('filePreviewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFilePreview();
            }
        });

        // Feedback UI
        function setupFeedbackUI() {
            const fab = document.getElementById('feedbackFab');
            const modal = document.getElementById('feedbackModal');
            const closeBtn = document.getElementById('feedbackClose');
            const form = document.getElementById('feedbackForm');
            const result = document.getElementById('fbResult');

            fab.addEventListener('click', () => {
                modal.classList.remove('hidden');
                requestAnimationFrame(() => modal.classList.add('open'));
            });
            closeBtn.addEventListener('click', () => hideFeedbackModal());
            modal.addEventListener('click', (e) => { if (e.target === modal) hideFeedbackModal(); });

            function hideFeedbackModal() {
                modal.classList.remove('open');
                setTimeout(() => modal.classList.add('hidden'), 520);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                result.textContent = '';
                const payload = {
                    full_name: document.getElementById('fbFullName').value.trim(),
                    contact: document.getElementById('fbContact').value.trim(),
                    message: document.getElementById('fbMessage').value.trim()
                };
                try {
                    const resp = await fetch(`${API_BASE}/api/feedback/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    result.className = 'text-sm text-green-600';
                    result.textContent = 'Rahmat! Fikringiz yuborildi.';
                    form.reset();
                    setTimeout(() => hideFeedbackModal(), 800);
                } catch (err) {
                    result.className = 'text-sm text-red-600';
                    result.textContent = 'Yuborishda xatolik. Keyinroq urinib ko窶腕ing.';
                }
            });
        }
    </script>
</body>
</html>