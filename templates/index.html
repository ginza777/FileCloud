{% load static %}
<!DOCTYPE html>
<html lang="uz" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FayltopAi fayl qidiruv</title>
    <link rel="icon" type="image/x-icon" href="{% static 'icon.png' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                screens: { 'xs': '475px', 'sm': '640px', 'md': '768px', 'lg': '1024px', 'xl': '1280px', '2xl': '1536px' },
                extend: {
                    colors: { primary: '#0ea5e9', secondary: '#06b6d4', dark: '#0f172a', light: '#f8fafc' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; color: #0f172a; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeInUp { animation: fadeInUp 0.7s ease-out forwards; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; }
        .ios-modal { opacity: 0; backdrop-filter: blur(0px); transition: opacity 420ms ease, backdrop-filter 420ms ease; }
        .ios-modal.open { opacity: 1; backdrop-filter: blur(8px); }
        .ios-sheet { transform: translateY(24px) scale(0.98); opacity: 0; transition: transform 520ms cubic-bezier(.22,.61,.36,1), opacity 380ms ease; }
        .ios-modal.open .ios-sheet { transform: translateY(0) scale(1); opacity: 1; }
        .gradient-bg { background-image: linear-gradient(to right, #0ea5e9, #06b6d4); }
        .ignite-glass { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .ignite-btn { background-image: linear-gradient(to right, #0ea5e9, #06b6d4); color: white; }
    </style>
</head>
<body>
    {% csrf_token %}

    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <a href="/" class="flex items-center gap-2 text-xl font-bold text-primary">
                    <img src="{% static 'fayltop_transparent.svg' %}" alt="FaylTop Logo" class="w-9 h-9 sm:w-10 sm:h-10">
                    <span class="hidden sm:inline">FaylTop.Cloud</span>
                    <span class="sm:hidden">FaylTop</span>
                </a>
                <a href="https://t.me/{{ bot_username }}" target="_blank" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition flex items-center gap-2 text-sm font-medium">
                    <i data-feather="message-circle" class="w-4 h-4"></i>
                    <span class="hidden xs:inline">FaylTop Bot</span>
                    <span class="xs:hidden">Bot</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <section class="relative text-white py-20 md:py-28 overflow-hidden bg-sky-500">
             <div class="absolute inset-0 z-0">
                <video class="w-full h-full object-cover" autoplay muted loop playsinline poster="{% static 'image_main.png' %}">
                    <source src="{% static 'video_main.mp4' %}" type="video/mp4">
                </video>
                <div class="absolute inset-0 bg-black/50"></div>
            </div>
            <div class="container mx-auto px-4 text-center relative z-10">
                <h1 class="text-4xl md:text-6xl font-extrabold mb-4 animate-fadeInUp" style="animation-delay: 0.1s;">FayltopAi fayl qidiruv</h1>
                <p class="text-lg md:text-xl mb-8 max-w-3xl mx-auto text-white/90 animate-fadeInUp" style="animation-delay: 0.2s;">Sifatli va tayyor ishlardan foydalaning, vaqt va kuchingizni tejang.</p>

                <div class="max-w-3xl mx-auto bg-white/20 backdrop-blur-md rounded-full p-2 animate-fadeInUp" style="animation-delay: 0.3s;">
                    <form id="searchForm" class="flex flex-col sm:flex-row gap-2" onsubmit="performSearch(event)">
                        <input id="searchInput" type="text" placeholder="Qaysi turdagi fayl qidirmoqdasiz?" class="w-full px-6 py-3 rounded-full text-dark focus:outline-none focus:ring-2 focus:ring-sky-400 text-base">
                        <button id="searchBtn" type="submit" class="w-full sm:w-auto bg-primary text-white px-8 py-3 rounded-full hover:bg-sky-600 transition font-semibold text-base">Qidirish</button>
                    </form>
                </div>

                <div class="mt-6 flex justify-center items-center gap-4 animate-fadeInUp" style="animation-delay: 0.4s;">
                    <label for="deepToggle" class="flex items-center gap-3 cursor-pointer select-none">
                        <span class="text-sm text-white/80">Chuqurlashtirilgan Qidiruv</span>
                        <div class="relative">
                            <input id="deepToggle" type="checkbox" class="sr-only peer">
                            <div class="w-14 h-8 bg-white/30 rounded-full peer-checked:bg-gradient-to-r peer-checked:from-orange-500 peer-checked:to-red-600 transition-colors"></div>
                            <div class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full transition-transform peer-checked:translate-x-6"></div>
                        </div>
                    </label>
                </div>
                 <p id="searchInfo" class="mt-4 text-sm text-white/90 animate-fadeInUp" style="animation-delay: 0.5s;"><span class="font-semibold text-sky-300">Oddiy Qidiruv:</span> Faqat fayl nomi bilan qidirish</p>
            </div>
        </section>

        <section class="py-12 sm:py-16">
            <div class="container mx-auto px-4">
                <h2 id="fileSectionTitle" class="text-3xl font-bold mb-8 text-center">Top Fayllar</h2>

                <div id="fileListContainer">
                    <div id="skeletonLoader" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for i in "123456" %}
                        <div class="bg-white rounded-xl p-5 shadow-md">
                            <div class="flex items-center mb-4 gap-4">
                                <div class="w-12 h-12 rounded-lg shimmer"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 shimmer"></div>
                                    <div class="h-3 bg-gray-200 rounded w-1/2 shimmer"></div>
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <div class="h-4 bg-gray-200 rounded w-1/4 shimmer"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/4 shimmer"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div id="errorMessage" class="hidden text-center bg-red-50 border-l-4 border-red-400 text-red-700 p-6 rounded-lg max-w-2xl mx-auto">
                        <div class="flex items-center justify-center gap-4">
                            <i data-feather="alert-triangle" class="w-8 h-8"></i>
                            <div>
                                <p class="font-bold text-lg">Xatolik yuz berdi</p>
                                <p class="text-base">Fayllarni yuklab bo'lmadi. Iltimos, keyinroq qayta urinib ko'ring.</p>
                            </div>
                        </div>
                    </div>

                    <div id="fileGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
                </div>

                <div id="paginationContainer" class="flex justify-center mt-12"></div>
            </div>
        </section>
    </main>

    <section class="py-8 bg-white">
        <div class="container mx-auto px-4">
            <div class="text-center mb-4">
                <h2 class="text-xl font-semibold">Tayyor mahsulotlardan foydalanish qanday ishlaydi?</h2>
            </div>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-center sm:justify-between gap-4 sm:gap-3 rounded-xl p-3 ignite-glass">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">1</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2"><i data-feather="search" class="w-4 h-4 text-gray-500"></i><span>Qidiring va tanlang</span></div>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">2</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2"><i data-feather="credit-card" class="w-4 h-4 text-gray-500"></i><span>Sotib oling</span></div>
                </div>
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 rounded-full gradient-bg flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">3</div>
                    <div class="text-sm text-gray-700 flex items-center gap-2"><i data-feather="download" class="w-4 h-4 text-gray-500"></i><span>Yuklab oling</span></div>
                </div>
            </div>
        </div>
    </section>

    <div id="filePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden ios-modal flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-6xl h-5/6 flex flex-col ios-sheet">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="previewFileName" class="text-lg sm:text-xl font-semibold text-primary truncate pr-2"></h3>
                <button onclick="closeFilePreview()" class="text-gray-500 hover:text-gray-700 flex-shrink-0"><i data-feather="x" class="w-6 h-6"></i></button>
            </div>
             <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <div id="previewImagesContainer" class="w-full lg:w-7/12 border-b lg:border-b-0 lg:border-r p-4 overflow-auto space-y-3">
                    </div>
                <div class="w-full lg:w-5/12 p-6 overflow-auto">
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold mb-2">Fayl Ma'lumotlari</h4>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between"><span>Format:</span><span id="previewFileType" class="font-medium"></span></div>
                            <div class="flex justify-between"><span>Hajmi:</span><span id="previewFileSize" class="font-medium"></span></div>
                            <div class="flex justify-between"><span>Ko'rishlar:</span><span id="previewViews" class="font-medium"></span></div>
                            <div class="flex justify-between"><span>Yuklab olishlar:</span><span id="previewDownloads" class="font-medium"></span></div>
                        </div>
                    </div>
                    <button id="downloadBtn" onclick="downloadFile()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-sky-600 transition flex items-center justify-center text-base font-semibold">
                        <i data-feather="download" class="w-5 h-5 mr-2"></i><span>Telegram orqali yuklab olish</span>
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-2">Yuklab olish uchun Telegram botimizdan foydalaning</p>
                </div>
            </div>
        </div>
    </div>

    <button id="feedbackFab" aria-label="Fikr qoldirish" class="fixed z-50 bottom-5 right-5 w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-xl hover:shadow-2xl hover:scale-105 transition flex items-center justify-center">
        <i data-feather="message-circle" class="w-7 h-7"></i>
    </button>

    <div id="feedbackModal" class="fixed inset-0 hidden ios-modal z-50 flex items-end sm:items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50" onclick="closeFeedbackModal()"></div>
        <div class="w-full sm:max-w-md bg-white rounded-2xl ios-sheet p-4 sm:p-5 relative">
            <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold">Fikr qoldirish</h3>
                <button id="feedbackClose" class="text-gray-500 hover:text-gray-700" aria-label="Yopish" onclick="closeFeedbackModal()"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>
            <form id="feedbackForm" class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ism Familiya</label>
                    <input id="fbFullName" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ismingiz va familiyangiz" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Aloqa (ixtiyoriy)</label>
                    <input id="fbContact" type="text" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Telefon, email yoki Telegram">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Xabar</label>
                    <textarea id="fbMessage" rows="4" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Fikringizni yozing" required></textarea>
                </div>
                <button type="submit" class="w-full ignite-btn rounded-lg py-2.5 font-medium">Yuborish</button>
                <p id="fbResult" class="text-sm"></p>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();

        // --- GLOBAL VARIABLES & CONFIG ---
        const API_BASE = '{{ MAIN_URL }}';
        const TOP_FILES_API = `${API_BASE}/api/files/top-downloads/`;
        const SEARCH_API = `${API_BASE}/api/files/search/`;
        const DOCUMENT_IMAGES_API = (docId) => `${API_BASE}/api/files/${docId}/images/`;
        const FEEDBACK_API = `${API_BASE}/api/files/feedback/`;
        const filesPerPage = 9;
        let isDeepMode = false;
        let currentFileId = null;
        let currentSearchQuery = '';
        let currentSearchPage = 1;
        let currentSearchFn = loadTopFiles;

        // --- DOM ELEMENTS ---
        const fileGrid = document.getElementById('fileGrid');
        const skeletonLoader = document.getElementById('skeletonLoader');
        const errorMessage = document.getElementById('errorMessage');
        const fileSectionTitle = document.getElementById('fileSectionTitle');
        const searchInput = document.getElementById('searchInput');

        // --- UI STATE MANAGEMENT ---
        function showLoadingState() {
            skeletonLoader.classList.remove('hidden');
            fileGrid.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showContentState() {
            fileGrid.classList.remove('hidden');
            skeletonLoader.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function showErrorState() {
            errorMessage.classList.remove('hidden');
            skeletonLoader.classList.add('hidden');
            fileGrid.classList.add('hidden');
        }

        // --- API & DATA FETCHING ---
        async function fetchData(url) {
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP xatosi! Status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`${attempt}-urinishda xatolik (${url}):`, error);
                    if (attempt === 3) throw error;
                    await new Promise(res => setTimeout(res, 1000 * attempt));
                }
            }
        }

        async function loadTopFiles(page = 1) {
            showLoadingState();
            fileSectionTitle.textContent = "Top Fayllar";
            currentSearchFn = loadTopFiles;
            try {
                const data = await fetchData(`${TOP_FILES_API}?page=${page}&page_size=${filesPerPage}`);
                if (data && data.results) {
                    displayFiles(data.results);
                    generatePagination(data.total_pages, page, loadTopFiles);
                    showContentState();
                } else {
                    showErrorState();
                }
            } catch (error) {
                console.error('Top fayllarni yuklashda xatolik:', error);
                showErrorState();
            }
        }

        window.performSearch = async function(event, page = 1) {
            if (event) event.preventDefault();
            const query = searchInput.value.trim();

            if (!query) {
                loadTopFiles();
                return;
            }

            currentSearchQuery = query;
            currentSearchPage = page;
            currentSearchFn = (p) => performSearch(null, p);

            showLoadingState();
            fileSectionTitle.textContent = `"${query}" uchun natijalar`;
            const searchUrl = `${SEARCH_API}?q=${encodeURIComponent(query)}&deep=${isDeepMode}&page=${page}&page_size=${filesPerPage}`;

            try {
                const data = await fetchData(searchUrl);
                if (data && data.results) {
                    displayFiles(data.results);
                    generatePagination(data.total_pages, page, currentSearchFn);
                    showContentState();

                    // Qidiruv natijalarining sonini ko'rsatish
                    const resultsCount = data.total || data.results.length;
                    const searchMode = isDeepMode ? 'chuqurlashtirilgan' : 'oddiy';
                    const searchInfo = document.createElement('div');
                    searchInfo.className = 'text-center text-sm text-gray-600 mb-6';
                    searchInfo.innerHTML = `
                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full">
                            <span class="font-medium">${resultsCount}</span> ta natija topildi
                            <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-500 rounded-full">${searchMode} qidiruv</span>
                        </div>
                    `;

                    // Natijalar sonini ko'rsatish
                    const existingInfo = document.querySelector('.search-results-info');
                    if (existingInfo) {
                        existingInfo.remove();
                    }
                    searchInfo.classList.add('search-results-info');
                    fileGrid.parentNode.insertBefore(searchInfo, fileGrid);
                } else {
                    showErrorState();
                }
            } catch (error) {
                console.error('Failed to perform search:', error);
                showErrorState();
            }
        }

        // Pagination uchun handleSearchPagination funksiyasini ham yangilash
        async function handleSearchPagination(update, context, user, language) {
            // ...existing code...
            try {
                const data = await fetchData(searchUrl);
                if (data && data.results) {
                    displayFiles(data.results);
                    generatePagination(data.total_pages, page, currentSearchFn);
                    showContentState();

                    // Qidiruv natijalarining sonini ko'rsatish
                    const resultsCount = data.total || data.results.length;
                    const searchMode = isDeepMode ? 'chuqurlashtirilgan' : 'oddiy';
                    const searchInfo = document.createElement('div');
                    searchInfo.className = 'text-center text-sm text-gray-600 mb-6';
                    searchInfo.innerHTML = `
                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-full">
                            <span class="font-medium">${resultsCount}</span> ta natija topildi
                            <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-500 rounded-full">${searchMode} qidiruv</span>
                        </div>
                    `;

                    // Natijalar sonini ko'rsatish
                    const existingInfo = document.querySelector('.search-results-info');
                    if (existingInfo) {
                        existingInfo.remove();
                    }
                    searchInfo.classList.add('search-results-info');
                    fileGrid.parentNode.insertBefore(searchInfo, fileGrid);
                } else {
                    showErrorState();
                }
            } catch (error) {
                console.error('Failed to perform search:', error);
                showErrorState();
            }
        }

        // --- RENDERING ---
        function createFileCard(file) {
            const fileType = (file.title.split('.').pop() || 'FILE').substring(0, 4).toUpperCase();
            const fileSize = file.file_size ? `${(file.file_size / 1024 / 1024).toFixed(2)} MB` : 'N/A';
            const escapedTitle = file.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');

            return `
                <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-lg hover:scale-[1.02] transition-all duration-300 cursor-pointer group"
                     onclick="showFilePreview('${file.document_id}', '${escapedTitle}', '${fileType}', '${fileSize}', '${file.view_count || 0}', '${file.download_count || 0}')">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-sky-50 text-sky-600 font-bold text-xs flex items-center justify-center rounded-lg flex-shrink-0 group-hover:bg-sky-100 transition-colors">
                            ${fileType}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-semibold text-gray-800 truncate mb-1" title="${escapedTitle}">${file.title}</h3>
                            <div class="flex items-center gap-3 text-xs text-gray-500">
                                <span>${fileSize}</span>
                                <div class="h-3 w-px bg-gray-200"></div>
                                <div class="flex items-center gap-1" title="Ko'rishlar"><i data-feather="eye" class="w-3 h-3"></i><span>${file.view_count || 0}</span></div>
                                <div class="flex items-center gap-1" title="Yuklashlar"><i data-feather="download" class="w-3 h-3"></i><span>${file.download_count || 0}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayFiles(files) {
            if (files.length === 0) {
                fileGrid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500">Hech narsa topilmadi.</div>`;
                return;
            }
            fileGrid.innerHTML = files.map(createFileCard).join('');
            feather.replace();
        }

        function generatePagination(totalPages, currentPage, pageChangeFn) {
            const container = document.getElementById('paginationContainer');
            if (totalPages <= 1) {
                container.innerHTML = ''; return;
            }
            let html = '<div class="flex items-center space-x-1 sm:space-x-2">';
            const createButton = (page, content, disabled = false, active = false) => {
                const base = 'w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg border text-sm transition-colors';
                let state = 'border-gray-300 text-gray-600 hover:bg-gray-50';
                if (disabled) state = 'border-gray-200 text-gray-400 cursor-not-allowed bg-gray-50';
                if (active) state = 'bg-primary text-white border-primary cursor-default';
                return `<button class="${base} ${state}" ${disabled ? 'disabled' : ''} onclick="!${active} && !${disabled} && handlePageClick(${page})">${content}</button>`;
            };
            html += createButton(currentPage - 1, '<i data-feather="chevron-left" class="w-4 h-4"></i>', currentPage === 1);
            const pages = [...new Set([1, totalPages, currentPage, currentPage-1, currentPage+1].filter(p => p > 0 && p <= totalPages))].sort((a,b) => a-b);
            let lastPage = 0;
            pages.forEach(p => {
                if (p - lastPage > 1) html += '<span class="px-2 text-gray-500 hidden sm:inline">...</span>';
                html += createButton(p, p, false, p === currentPage);
                lastPage = p;
            });
            html += createButton(currentPage + 1, '<i data-feather="chevron-right" class="w-4 h-4"></i>', currentPage === totalPages);
            html += '</div>';
            container.innerHTML = html;
            feather.replace();
        }

        window.handlePageClick = function(page) {
            if (page < 1) return;
            currentSearchFn(page);
            window.scrollTo({ top: document.getElementById('fileSectionTitle').offsetTop - 80, behavior: 'smooth' });
        }

        // --- MODAL & INTERACTIONS ---
        window.showFilePreview = async function(docId, name, type, size, views, downloads) {
            currentFileId = docId;
            document.getElementById('previewFileName').textContent = name;
            document.getElementById('previewFileType').textContent = type;
            document.getElementById('previewFileSize').textContent = size;
            document.getElementById('previewViews').textContent = views;
            document.getElementById('previewDownloads').textContent = downloads;

            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => modal.classList.add('open'));
            document.body.style.overflow = 'hidden';

            const imagesContainer = document.getElementById('previewImagesContainer');
            imagesContainer.innerHTML = '<div class="h-40 w-full shimmer rounded-lg"></div><div class="h-40 w-full shimmer rounded-lg"></div>';

            try {
                // API URL manzilini to'g'riladim
                const data = await fetchData(DOCUMENT_IMAGES_API(docId));
                if (data.images && data.images.length > 0) {
                    imagesContainer.innerHTML = data.images.map(img =>
                        `<img src="${img.url}" alt="Sahifa ${img.page}" class="w-full h-auto rounded-lg shadow-sm mb-3 border">`
                    ).join('');
                } else {
                    imagesContainer.innerHTML = '<p class="text-center text-gray-500 py-10">Rasmli ko\'rinish mavjud emas</p>';
                }
            } catch (error) {
                console.error("Fayl rasmlarini yuklashda xatolik:", error);
                imagesContainer.innerHTML = '<p class="text-center text-red-500 py-10">Ma\'lumotlarni yuklab bo\'lmadi.</p>';
            }
        }

        window.closeFilePreview = function() {
            const modal = document.getElementById('filePreviewModal');
            modal.classList.remove('open');
            setTimeout(() => { modal.classList.add('hidden'); }, 520);
            document.body.style.overflow = 'auto';
            currentFileId = null;
        }

        window.downloadFile = function() {
            if (!currentFileId) return;
            window.open(`https://t.me/{{ bot_username }}?start=download_${currentFileId}`, '_blank');
        }

        // --- FEEDBACK MODAL ---
        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackFab = document.getElementById('feedbackFab');
        function openFeedbackModal() {
            feedbackModal.classList.remove('hidden');
            requestAnimationFrame(() => feedbackModal.classList.add('open'));
            document.body.style.overflow = 'hidden';
        }
        window.closeFeedbackModal = function() {
            feedbackModal.classList.remove('open');
            setTimeout(() => { feedbackModal.classList.add('hidden'); }, 520);
            document.body.style.overflow = 'auto';
        }
        feedbackFab.addEventListener('click', openFeedbackModal);

        document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const resultEl = document.getElementById('fbResult');
            resultEl.textContent = 'Yuborilmoqda...';
            resultEl.className = 'text-sm text-blue-600 text-center';
            try {
                const response = await fetch(FEEDBACK_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        full_name: document.getElementById('fbFullName').value,
                        contact: document.getElementById('fbContact').value,
                        message: document.getElementById('fbMessage').value,
                    })
                });
                if (!response.ok) throw new Error('Server xatosi');
                resultEl.textContent = 'Rahmat! Fikringiz qabul qilindi.';
                resultEl.className = 'text-sm text-green-600 text-center';
                e.target.reset();
                setTimeout(closeFeedbackModal, 2000);
            } catch (error) {
                resultEl.textContent = 'Xatolik yuz berdi. Qaytadan urinib ko\'ring.';
                resultEl.className = 'text-sm text-red-600 text-center';
            }
        });

        // --- EVENT LISTENERS ---
        document.getElementById('deepToggle').addEventListener('change', (e) => {
            isDeepMode = e.target.checked;
            const searchInfo = document.getElementById('searchInfo');
            searchInfo.innerHTML = isDeepMode
                ? '<span class="font-semibold text-orange-300">Chuqurlashtirilgan Qidiruv:</span> Fayl ichidan ham qidirish'
                : '<span class="font-semibold text-sky-300">Oddiy Qidiruv:</span> Faqat fayl nomi bilan qidirish';
            if (searchInput.value.trim()) { performSearch(null, 1); }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFilePreview();
                closeFeedbackModal();
            }
        });
        document.getElementById('filePreviewModal').addEventListener('click', (e) => e.target === e.currentTarget && closeFilePreview());

        // --- INITIAL LOAD ---
        loadTopFiles();
    });
    </script>
</body>
</html>

