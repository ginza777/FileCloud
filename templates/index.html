{% load static %}
<!DOCTYPE html>
<html lang="uz" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FaylHubAi fayl qidiruv</title>
    <link rel="icon" type="image/x-icon" href="{% static 'icon.png' %}">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.7s ease-out forwards;
        }

        /* Logo size - kattalashtirilgan */
        .site-logo {
            width: 48px !important;
            height: 48px !important;
            max-width: 64px !important;
            max-height: 64px !important;
            object-fit: contain;
            transition: width 150ms ease, height 150ms ease;
        }

        @media (min-width: 640px) {
            .site-logo {
                width: 56px !important;
                height: 56px !important;
                max-width: 64px !important;
                max-height: 64px !important;
            }
        }

        @media (min-width: 768px) {
            .site-logo {
                width: 64px !important;
                height: 64px !important;
                max-width: 64px !important;
                max-height: 64px !important;
            }
        }

        /* Animatsiyali gradient background */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .animated-gradient {
            background: linear-gradient(-45deg, #ff6b35, #f7931e, #ff8c42, #ff6b35);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            transition: background 0.5s ease;
        }

        .animated-gradient.deep-search {
            background: linear-gradient(-45deg, #dc2626, #ef4444, #f87171, #dc2626);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }

        .ios-modal {
            opacity: 0;
            backdrop-filter: blur(0px);
            transition: opacity 420ms ease, backdrop-filter 420ms ease;
        }

        .ios-modal.open {
            opacity: 1;
            backdrop-filter: blur(8px);
        }

        .ios-sheet {
            transform: translateY(24px) scale(0.98);
            opacity: 0;
            transition: transform 520ms cubic-bezier(.22, .61, .36, 1), opacity 380ms ease;
            overflow: hidden;
        }

        .ios-modal.open .ios-sheet {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .gradient-bg {
            background-image: linear-gradient(to right, #F69600, #FFCD00);
        }

        .ignite-glass {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ignite-btn {
            background-image: linear-gradient(to right, #F69600, #FFCD00);
            color: white;
        }

        .file-card {
            background: #fff;
            border-radius: 1rem;
            padding: 1.25rem;
            box-shadow: 0 5px 16px rgba(15, 23, 42, 0.08);
            transition: transform .2s ease, box-shadow .2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: .75rem;
        }

        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
        }

        .preview-thumb {
            width: 100%;
            height: 10rem;
            border-radius: .75rem;
            overflow: hidden;
            background: #f1f5f9;
        }

        .preview-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .preview-thumb.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: .85rem;
            font-weight: 500;
        }

        /* Vertical scroll for preview images */
        .preview-scroll {
            scroll-snap-type: y mandatory;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(90vh - 250px); /* Responsive height - modal height minus header/footer */
            padding-right: 8px;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        @media (max-width: 640px) {
            .preview-scroll {
                max-height: calc(90vh - 200px); /* Smaller on mobile */
            }
        }

        @media (min-width: 1024px) {
            .preview-scroll {
                max-height: calc(90vh - 280px); /* Larger on desktop */
            }
        }

        .preview-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .preview-scroll::-webkit-scrollbar-thumb {
            background: rgba(15, 23, 42, .2);
            border-radius: 999px;
        }

        .preview-scroll::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, .05);
            border-radius: 999px;
        }

        .preview-card {
            scroll-snap-align: start;
            width: 100%;
            background: #fff;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }

        .preview-card-img {
            position: relative;
            width: 100%;
            min-height: 400px;
            max-height: 70vh;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .preview-card-img img {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
            display: block;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: none;
        }

        /* Watermark removed as per requirements */
        /* Prevent image download */
        .preview-card-img {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Pagination Styles */
        .pagination-button {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .pagination-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .pagination-button.active {
            background: linear-gradient(135deg, #0ea5e9, #06b6d4);
            color: white;
            font-weight: 600;
        }

        .pagination-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        /* Mobile Search Form Optimizations */
        @media (max-width: 640px) {
            .preview-thumb {
                height: 8rem;
            }

            .preview-card-img {
                min-height: 300px;
                max-height: 50vh;
            }

            #searchInput {
                padding: 12px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            #searchBtn {
                padding: 12px 20px;
                font-size: 14px;
                min-height: 44px; /* Touch target */
            }

            /* Mobile Pagination */
            .pagination-button {
                min-width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            #searchInput {
                padding: 10px 14px;
                font-size: 15px;
            }

            #searchBtn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>

<div id="detailModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog"
     aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity opacity-0" id="modalBackdrop"
         onclick="closeDetailModal()"></div>

    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">

            <div id="modalContainer"
                 class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 w-full max-w-md opacity-0 scale-95 duration-300">

                <button onclick="closeDetailModal()"
                        class="absolute top-4 right-4 z-20 bg-white/50 hover:bg-white p-2 rounded-full text-slate-500 hover:text-red-500 transition backdrop-blur-sm">
                    <i class="feather-x w-5 h-5"></i>
                </button>

                <div class="flex flex-col md:flex-row h-full" id="modalLayout">

                    <div id="modalImagePart" class="hidden md:w-1/2 bg-slate-100 relative min-h-[300px]">
                        <div id="imageLoader" class="absolute inset-0 flex items-center justify-center">
                            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
                        </div>
                        <img id="modalMainImage" src="" alt="Fayl rasmi"
                             class="w-full h-full object-cover absolute inset-0 hidden">

                        <div id="imageCountBadge"
                             class="absolute bottom-4 right-4 bg-black/60 text-white text-xs px-3 py-1 rounded-full backdrop-blur-md hidden">
                            <span id="imgCount">0</span> sahifa
                        </div>
                    </div>

                    <div id="modalInfoPart" class="w-full p-6 md:p-8 flex flex-col justify-center">

                        <div id="modalFallbackIcon" class="hidden mb-6 text-center">
                            <div class="w-20 h-20 bg-blue-50 rounded-2xl flex items-center justify-center mx-auto text-blue-500 mb-2">
                                <i id="fileTypeIcon" class="feather-file-text w-10 h-10"></i>
                            </div>
                        </div>

                        <h3 id="modalTitle" class="text-2xl font-bold text-slate-800 mb-2 leading-tight">
                            Fayl nomi yuklanmoqda...
                        </h3>

                        <div class="flex flex-wrap gap-3 text-sm text-slate-500 mb-6" id="modalMetaTags">
                            <span class="bg-slate-100 px-3 py-1 rounded-lg flex items-center gap-1">
                                <i class="feather-hard-drive w-4 h-4"></i> <span id="modalSize">0 MB</span>
                            </span>
                            <span class="bg-slate-100 px-3 py-1 rounded-lg flex items-center gap-1">
                                <i class="feather-eye w-4 h-4"></i> <span id="modalViews">0</span>
                            </span>
                            <span class="bg-slate-100 px-3 py-1 rounded-lg flex items-center gap-1">
                                <i class="feather-download w-4 h-4"></i> <span id="modalDownloads">0</span>
                            </span>
                        </div>

                        <p id="modalDescription" class="text-slate-600 mb-8 text-sm line-clamp-3">
                            Ushbu fayl haqida qo'shimcha ma'lumot mavjud emas.
                        </p>

                        <div class="mt-auto space-y-3">
                            <a id="modalDownloadBtn" href="#"
                               class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center font-bold py-3.5 rounded-xl transition shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">
                                <i class="feather-download"></i> Yuklab olish
                            </a>
                            <button onclick="shareFile()"
                                    class="block w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3.5 rounded-xl transition flex items-center justify-center gap-2">
                                <i class="feather-share-2"></i> Ulashish
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<script>
    feather.replace();

    // Global o'zgaruvchilar
    const modal = document.getElementById('detailModal');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContainer = document.getElementById('modalContainer');
    const modalImagePart = document.getElementById('modalImagePart');
    const modalInfoPart = document.getElementById('modalInfoPart');

    // Fayl hajmini chiroyli formatlash
    function formatFileSize(bytes) {
        if (!bytes) return 'Noma\'lum';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        return `${size % 1 === 0 ? size : size.toFixed(1)} ${units[unitIndex]}`;
    }

    // Kartochkani chizish funksiyasi (Render)
    function renderFileCard(file) {
        // Xavfsiz matnlar
        const safeTitle = (file.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

        // Rasm (Preview) logikasi - undefined bo'lmasligi uchun tekshiramiz
        const coverImage = file.preview_image_small || file.preview_image_large;

        // Agar rasm bo'lsa HTML, bo'lmasa Placeholder
        let previewBlock = '';
        if (coverImage && coverImage !== 'null' && coverImage !== 'undefined') {
            previewBlock = `<div class="preview-thumb"><img src="${coverImage}" alt="${safeTitle}" loading="lazy" decoding="async" onerror="this.parentElement.innerHTML='<div class=\\'preview-thumb placeholder\\'>Rasm yo\\'q</div>'"></div>`;
        } else {
            previewBlock = `<div class="preview-thumb placeholder">Rasm tayyorlanmoqda</div>`;
        }

        // Meta ma'lumotlar
        const meta = [];
        if (file.page_count) meta.push(`${file.page_count} sahifa`);

        let formattedSize = '0 MB';
        if (file.file_size) {
            formattedSize = formatFileSize(file.file_size);
            if (formattedSize) meta.push(formattedSize);
        }

        const metaText = meta.length ? `<p class="text-xs text-gray-500">${meta.join(' ‚Ä¢ ')}</p>` : '';

        // ID ni aniqlash (Xatolikni oldini olish)
        const docId = file.id || file.document_id;
        const fileUrl = file.file || file.url || '#';
        const extension = file.extension || 'file';

        if (!docId) {
            console.error("Fayl ID topilmadi:", file);
            return ''; // ID bo'lmasa kartochka chiqarmaymiz
        }

        return `
            <div data-product-id="${docId}" class="file-card" onclick="openDetailModal(
                '${docId}',
                '${safeTitle}',
                '${formattedSize}',
                '${file.download_count || 0}',
                '${file.view_count || 0}',
                '${fileUrl}',
                '${extension}'
            )">
                ${previewBlock}
                <h3 class="text-lg font-semibold line-clamp-2">${file.title || 'Nomlanmagan fayl'}</h3>
                ${metaText}
            </div>
        `;
    }

    // Modalni ochish funksiyasi (Asosiy logika shu yerda tuzatildi)
    function openDetailModal(docId, title, size, downloads, views, fileUrl, extension) {
        if (!docId || docId === 'undefined') {
            console.error("Xatolik: Document ID noto'g'ri:", docId);
            return;
        }

        // 1. Modalni ochish
        modal.classList.remove('hidden');
        setTimeout(() => {
            modalBackdrop.classList.remove('opacity-0');
            modalContainer.classList.remove('opacity-0', 'scale-95');
            modalContainer.classList.add('opacity-100', 'scale-100');
        }, 10);

        // 2. Ma'lumotlarni to'ldirish
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalSize').innerText = size;
        document.getElementById('modalDownloads').innerText = downloads;
        document.getElementById('modalViews').innerText = views;
        document.getElementById('modalDownloadBtn').href = fileUrl;

        // Iconni to'g'irlash
        const iconEl = document.getElementById('fileTypeIcon');
        if (extension === 'pdf') iconEl.className = 'feather-file-text w-10 h-10';
        else if (['doc', 'docx'].includes(extension)) iconEl.className = 'feather-file w-10 h-10';
        else iconEl.className = 'feather-file w-10 h-10';
        feather.replace();

        // 3. Reset qilish
        resetModalState();

        // 4. API orqali rasmlarni yuklash (Xatolik tuzatildi)
        fetch(`/api/web/${docId}/images/`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // Rasm URLini turli xil maydonlardan qidirib ko'ramiz
                if (data.images && data.images.length > 0) {
                    const firstImg = data.images[0];
                    // Rasm manzilini aniqlash (image, file, url, large_url bo'lishi mumkin)
                    const imgUrl = firstImg.image || firstImg.file || firstImg.large_url || firstImg.url || firstImg.small_url;

                    if (imgUrl) {
                        enableLargeModal(imgUrl, data.count);
                    } else {
                        console.warn("Rasm obyekti bor, lekin URL topilmadi:", firstImg);
                        enableSmallModal();
                    }
                } else {
                    enableSmallModal();
                }
            })
            .catch(err => {
                console.error('Rasm yuklashda xatolik:', err);
                enableSmallModal();
            });
    }

    function resetModalState() {
        // Modalni boshlang'ich (kichik) holatga qaytarish
        modalContainer.className = "relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 w-full max-w-md opacity-100 scale-100 duration-300";
        modalImagePart.classList.add('hidden');
        modalInfoPart.className = "w-full p-6 md:p-8 flex flex-col justify-center";
        document.getElementById('modalFallbackIcon').classList.remove('hidden');
        document.getElementById('modalMainImage').classList.add('hidden');
        document.getElementById('modalMainImage').src = ''; // Eski rasmni tozalash
        document.getElementById('imageLoader').classList.remove('hidden');
        document.getElementById('imageCountBadge').classList.add('hidden');
    }

    function enableLargeModal(imageUrl, count) {
        if (!imageUrl) {
            enableSmallModal();
            return;
        }

        // Konteynerni kengaytiramiz
        modalContainer.classList.remove('max-w-md');
        modalContainer.classList.add('max-w-4xl');

        // Rasmni ko'rsatamiz
        modalImagePart.classList.remove('hidden');
        modalInfoPart.className = "w-full md:w-1/2 p-6 md:p-8 flex flex-col justify-center";
        document.getElementById('modalFallbackIcon').classList.add('hidden');

        // Rasmni yuklash
        const imgEl = document.getElementById('modalMainImage');
        imgEl.onload = () => {
            document.getElementById('imageLoader').classList.add('hidden');
            imgEl.classList.remove('hidden');
            if (count > 1) {
                document.getElementById('imageCountBadge').classList.remove('hidden');
                document.getElementById('imgCount').innerText = count;
            }
        };
        imgEl.onerror = () => {
            console.error("Rasmni yuklab bo'lmadi:", imageUrl);
            enableSmallModal(); // Rasm yuklanmasa kichik rejimga qaytamiz
        };
        imgEl.src = imageUrl;
    }

    function enableSmallModal() {
        modalContainer.classList.add('max-w-md');
        modalContainer.classList.remove('max-w-4xl');
        modalImagePart.classList.add('hidden');
        document.getElementById('modalFallbackIcon').classList.remove('hidden');
    }

    function closeDetailModal() {
        modalBackdrop.classList.add('opacity-0');
        modalContainer.classList.add('opacity-0', 'scale-95');
        modalContainer.classList.remove('opacity-100', 'scale-100');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('modalMainImage').src = '';
        }, 300);
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeDetailModal();
        }
    }

    // Sahifa yuklanganda ishga tushirish
    document.addEventListener('DOMContentLoaded', () => {
        // initPage() funksiyasi sizning kodingizda bo'lishi kerak
        if (typeof initPage === 'function') {
            initPage();
        }
    });
</script>
<body>
{% csrf_token %}

<header class="relative bg-white/80 backdrop-blur-lg shadow-sm w-full">
    <div class="w-full max-w-full px-4 md:px-6 lg:px-8 py-3">
        <div class="flex justify-between items-center w-full">
            <a href="/" class="flex items-center gap-2 text-xl font-bold text-primary">
                <img src="{% static 'faylhub-logo.svg' %}" alt="Faylhub Logo" class="site-logo">
                <span class="hidden sm:inline">Faylhub.uz</span>
                <span class="sm:hidden">Faylhub</span>
            </a>
            <a href="https://t.me/{{ bot_username }}" target="_blank"
               class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition flex items-center gap-2 text-sm font-medium whitespace-nowrap">
                <i data-feather="message-circle" class="w-4 h-4"></i>
                <span class="hidden xs:inline">FaylHub Bot</span>
                <span class="xs:hidden">Bot</span>
            </a>
        </div>
    </div>
</header>

<main>
    <section class="relative text-white py-20 md:py-28 overflow-hidden animated-gradient">
        <div class="absolute inset-0 z-0">
            <div class="absolute inset-0 bg-black/30"></div>
        </div>
        <div class="container mx-auto px-4 text-center relative z-10">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 animate-fadeInUp" style="animation-delay: 0.1s;">
                FaylHubAi fayl qidiruv</h1>
            <p class="text-lg md:text-xl mb-8 max-w-3xl mx-auto text-white/90 animate-fadeInUp"
               style="animation-delay: 0.2s;">Sifatli va tayyor ishlardan foydalaning, vaqt va kuchingizni tejang.</p>

            <div class="max-w-3xl mx-auto animate-fadeInUp" style="animation-delay: 0.3s;">
                <form id="searchForm" class="flex flex-col sm:flex-row gap-2" onsubmit="performSearch(event)">
                    <input id="searchInput" type="text" placeholder="Qaysi turdagi fayl qidirmoqdasiz?"
                           class="flex-1 bg-white/90 text-dark rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary shadow-sm placeholder-gray-400">
                    <button id="searchBtn" type="submit"
                            class="bg-primary hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-xl transition-colors">
                        Qidirish
                    </button>
                </form>
                <div class="switch-container">
                    <span class="switch-label">Oddiy qidiruv</span>
                    <label class="switch">
                        <input id="deepToggle" type="checkbox">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label">Chuqur qidiruv</span>
                </div>

                <!-- Deep Search Loading Progress -->
                <div id="deepSearchProgress" class="hidden mt-3">
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <span class="text-sm text-white/90 font-semibold">üîç Chuqurlashtirilgan qidiruv</span>
                                <div id="deepSearchCount" class="text-xs text-orange-300 mt-1">Topilgan fayllar: <span
                                        class="font-bold">0</span></div>
                            </div>
                            <span id="deepSearchPercent" class="text-lg font-bold text-orange-300">0%</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-3 mb-2">
                            <div id="deepSearchBar"
                                 class="bg-gradient-to-r from-orange-400 to-orange-600 h-3 rounded-full transition-all duration-500"
                                 style="width: 0%"></div>
                        </div>
                        <div id="deepSearchStatus" class="text-sm text-white/80 font-medium">Qidiruv boshlanmoqda...
                        </div>
                        <div id="deepSearchDetails" class="text-xs text-white/60 mt-1">Elasticsearch orqali
                            qidirilmoqda...
                        </div>
                    </div>
                </div>

                <p id="searchInfo" class="text-sm text-white/80 mt-2"><span class="font-semibold text-orange-200">Oddiy Qidiruv:</span>
                    Faqat fayl nomi bilan qidirish</p>
            </div>
        </div>
    </section>

    <!-- Search Results Section (moved to top) -->
    <section id="searchResultsSection" class="container mx-auto px-4 py-12 hidden">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl md:text-3xl font-bold">Qidiruv natijalari</h2>
            <div id="searchResultsCount" class="text-lg font-semibold text-primary">
                <!-- Results count will be populated by JavaScript -->
            </div>
        </div>
        <div id="searchResults" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Search results will be populated by JavaScript -->
        </div>
        <div id="pagination" class="flex justify-center gap-4 mt-8"></div>
    </section>

    <!-- Top Files Section (moved below search results) -->
    <section id="topFilesSection" class="container mx-auto px-4 py-12">
        <h2 class="text-2xl md:text-3xl font-bold text-center mb-8">Eng ommabop fayllar</h2>
        <div id="topFiles" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Top files will be populated by JavaScript -->
        </div>
        <div id="loading" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="shimmer h-48 rounded-xl"></div>
            <div class="shimmer h-48 rounded-xl"></div>
            <div class="shimmer h-48 rounded-xl"></div>
        </div>
    </section>
</main>


<!-- File Preview Modal -->
<div id="filePreviewModal" class="ios-modal fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="ios-sheet bg-white rounded-2xl w-full max-w-7xl mx-4 my-4 max-h-[95vh] flex flex-col lg:flex-row overflow-hidden">
        <!-- Close Button -->
        <button onclick="closeFilePreview()"
                class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 z-20 bg-white rounded-full p-2 shadow-lg">
            <i data-feather="x" class="w-5 h-5"></i>
        </button>

        <!-- Left Column - Document Preview (Mobile: Full width, Desktop: 60%) -->
        <div class="flex-1 lg:w-3/5 flex flex-col bg-gray-50 overflow-hidden">
            <!-- Header with title and views (Mobile only) -->
            <div class="lg:hidden p-4 border-b bg-white">
                <h2 id="previewTitleMobile" class="text-lg font-bold mb-2 pr-8"></h2>
                <div class="flex items-center gap-4 text-sm">
                        <span class="text-gray-500 flex items-center gap-1">
                            <i data-feather="eye" class="w-4 h-4"></i>
                            <span id="previewViewsMobile">0</span>
                        </span>
                </div>
            </div>

            <!-- Document Preview Area -->
            <div id="previewImages"
                 class="flex-1 overflow-y-auto p-4 lg:p-6 flex items-center justify-center bg-gray-100">
                <div class="text-sm text-gray-500">Rasmlar yuklanmoqda...</div>
            </div>
        </div>

        <!-- Right Column - File Info and Actions (Mobile: Full width, Desktop: 40%) -->
        <div class="lg:w-2/5 flex flex-col bg-white border-l border-gray-200 overflow-y-auto">
            <!-- Desktop Header -->
            <div class="hidden lg:block p-6 border-b">
                <h2 id="previewTitle" class="text-2xl font-bold mb-3 pr-8"></h2>
                <div class="flex items-center gap-4 text-sm">
                        <span class="text-gray-500 flex items-center gap-1">
                            <i data-feather="eye" class="w-4 h-4"></i>
                            <span id="previewViews">0</span>
                        </span>
                    <span class="text-gray-500 flex items-center gap-1">
                            <i data-feather="download" class="w-4 h-4"></i>
                            <span id="previewDownloads">0</span>
                        </span>
                </div>
            </div>

            <!-- File Details -->
            <div class="p-4 lg:p-6 space-y-4">
                <!-- Price Section -->
                <div class="flex items-center justify-between mb-4">
                    <span id="previewPrice" class="text-2xl font-bold text-gray-900">Bepul</span>
                    <button class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-feather="share-2" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- File Metadata -->
                <div id="previewMetadata" class="space-y-3 mb-4">
                    <!-- Metadata will be populated by JavaScript -->
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col gap-3 mb-4">
                    <button id="addToCartBtn"
                            class="flex items-center justify-center gap-2 w-full border-2 border-green-500 text-green-600 hover:bg-green-50 font-medium py-3 px-4 rounded-xl transition-colors">
                        <i data-feather="shopping-cart" class="w-5 h-5"></i>
                        Savatga qo'shish
                    </button>
                    <div class="flex gap-2">
                        <button id="favoriteBtn"
                                class="flex items-center justify-center border-2 border-green-500 text-green-600 hover:bg-green-50 font-medium py-3 px-4 rounded-xl transition-colors flex-1">
                            <i data-feather="heart" class="w-5 h-5"></i>
                        </button>
                        <a id="telegramBtn" href="#"
                           class="flex items-center justify-center gap-2 flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                            <i data-feather="download" class="w-5 h-5"></i>
                            Hoziroq xarid qilish
                        </a>
                    </div>
                </div>

                <!-- Tags Section -->
                <div id="previewTags" class="flex flex-wrap gap-2 pt-4 border-t">
                    <!-- Tags will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal"
     class="ios-modal fixed inset-0 bg-black/50 flex items-end sm:items-center sm:justify-center hidden">
    <div class="ios-sheet bg-white sm:rounded-2xl w-full sm:max-w-lg p-6 sm:p-8 relative">
        <button onclick="closeFeedbackModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
            <i data-feather="x" class="w-6 h-6"></i>
        </button>
        <h2 class="text-xl font-bold mb-4">Fikr-mulohaza</h2>
        <form id="feedbackForm" class="flex flex-col gap-4">
            <input id="fbContact" type="text" placeholder="Ismingiz yoki kontakt"
                   class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
            <textarea id="fbMessage" placeholder="Fikringizni yozing" rows="4"
                      class="border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
            <button type="submit" class="ignite-btn font-medium py-3 px-4 rounded-xl">Yuborish</button>
            <p id="fbResult" class="text-sm text-center"></p>
        </form>
    </div>
</div>

<footer class="bg-dark text-white py-12">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <h3 class="text-lg font-bold mb-4">Faylhub.uz</h3>
                <p class="text-sm text-gray-300">Tez va oson fayl qidirish xizmati. Sifatli hujjatlarni toping va
                    ulashing.</p>
            </div>
            <div>
                <h3 class="text-lg font-bold mb-4">Havolalar</h3>
                <ul class="text-sm text-gray-300 space-y-2">
                    <li><a href="https://t.me/{{ bot_username }}" target="_blank" class="hover:text-primary">Telegram
                        Bot</a></li>
                    <li><a href="#" onclick="openFeedbackModal()" class="hover:text-primary">Fikr-mulohaza</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-lg font-bold mb-4">Kontakt</h3>
                <p class="text-sm text-gray-300">Telegram: <a href="https://t.me/{{ bot_username }}" target="_blank"
                                                              class="hover:text-primary">{{ bot_username }}</a></p>
            </div>
        </div>
        <div class="mt-8 pt-8 border-t border-gray-700 text-center text-sm text-gray-400">
            &copy; 2025 FaylHub.uz. Barcha huquqlar himoyalangan.
        </div>
    </div>
</footer>

<script>
    feather.replace();
    // Search cache for pagination - stores batches of results
    let searchCache = {}; // Format: {query: {batches: {batchNum: [results]}, total: number, total_pages: number}}
    let currentSearchQuery = '';
    let currentSearchMode = false;
    let isDeepMode = false;
    const BOT_USERNAME = "{{ bot_username | safe }}".replace('@', '');
    const BATCH_SIZE = 10; // Number of pages per batch
    const PAGE_SIZE = 12; // Files per page

    // Load top files when page loads
    function initPage() {
        console.log('Initializing page...');
        try {
            loadTopFiles();
        } catch (error) {
            console.error('Error initializing page:', error);
        }
    }

    // Try multiple ways to ensure it loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
    } else {
        // DOM already loaded
        initPage();
    }

    // Fallback: also try after a short delay
    setTimeout(function () {
        const topFiles = document.getElementById('topFiles');
        if (topFiles && topFiles.innerHTML.trim() === '') {
            console.log('Top files still empty, retrying...');
            loadTopFiles();
        }
    }, 1000);

    function formatFileSize(bytes) {
        if (!bytes) return null;
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        return `${size % 1 === 0 ? size : size.toFixed(1)} ${units[unitIndex]}`;
    }

    function extractTagsFromTitle(title) {
        // Extract keywords from title for tags
        const commonWords = ['va', 'uchun', 'bilan', 'dan', 'ga', 'ni', 'da', 'de', 'bo\'lgan', 'bo\'lib', 'qilish', 'qilgan'];
        const words = title.toLowerCase()
            .replace(/[^\w\s]/g, ' ')
            .split(/\s+/)
            .filter(word => word.length > 3 && !commonWords.includes(word))
            .slice(0, 4); // Max 4 tags
        return words;
    }

    function renderFileCard(file) {
        // Matn ichidagi qo'shtirnoqlarni to'g'rilash (Xatolikni oldini olish uchun)
        const safeTitle = (file.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

        // Rasm (Preview) logikasi
        const coverImage = file.preview_image_small || file.preview_image_large;
        const previewBlock = coverImage
            ? `<div class="preview-thumb"><img src="${coverImage}" alt="${safeTitle}" loading="lazy" decoding="async"></div>`
            : `<div class="preview-thumb placeholder">Rasm tayyorlanmoqda</div>`;

        // Meta ma'lumotlar (Sahifa soni va hajmi)
        const meta = [];
        if (file.page_count) meta.push(`${file.page_count} sahifa`);

        // Hajmni formatlash (Masalan: 2.4 MB)
        let formattedSize = '0 MB';
        if (file.file_size) {
            formattedSize = formatFileSize(file.file_size);
            if (formattedSize) meta.push(formattedSize);
        }

        const metaText = meta.length ? `<p class="text-xs text-gray-500">${meta.join(' ‚Ä¢ ')}</p>` : '';

        // ID ni aniqlash (API dan document_id yoki id kelishi mumkin)
        // openDetailModal rasmlarni yuklash uchun UUID (document_id) ni kutadi
        const docId = file.document_id || file.id;
        const fileUrl = file.file || file.url || '#';
        const extension = file.extension || 'file';

        // Yangi ONCLICK hodisasi bilan qaytariladigan HTML
        return `
                <div data-product-id="${file.id}" class="file-card" onclick="openDetailModal(
                    '${docId}',
                    '${safeTitle}',
                    '${formattedSize}',
                    '${file.download_count || 0}',
                    '${file.view_count || 0}',
                    '${fileUrl}',
                    '${extension}'
                )">
                    ${previewBlock}
                    <h3 class="text-lg font-semibold line-clamp-2">${file.title || 'Nomlanmagan fayl'}</h3>
                    ${metaText}
                </div>
            `;
    }

    async function loadDocumentMetadata(documentId) {
        const previewMetadata = document.getElementById('previewMetadata');
        if (!previewMetadata) return;

        try {
            const response = await fetch(`/api/web/${documentId}/images/`);
            if (response.ok) {
                const data = await response.json();
                const meta = [];
                if (data.page_count) {
                    meta.push(`<div class="flex items-center gap-2 text-sm py-2"><i data-feather="file-text" class="w-4 h-4 text-green-600"></i><span class="text-gray-600">Betlar soni:</span><span class="font-semibold ml-auto">${data.page_count} ta</span></div>`);
                }
                if (data.file_size) {
                    const formatted = formatFileSize(data.file_size);
                    if (formatted) {
                        meta.push(`<div class="flex items-center gap-2 text-sm py-2"><i data-feather="hard-drive" class="w-4 h-4 text-green-600"></i><span class="text-gray-600">Fayl hajmi:</span><span class="font-semibold ml-auto">${formatted}</span></div>`);
                    }
                }
                meta.push(`<div class="flex items-center gap-2 text-sm py-2"><span class="text-gray-600">Fayl turi:</span><span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold ml-auto">.pdf</span></div>`);

                previewMetadata.innerHTML = meta.join('');
                feather.replace();
            }
        } catch (error) {
            console.error('Metadata yuklashda xatolik:', error);
        }
    }

    async function loadDocumentImages(documentId) {
        const previewImages = document.getElementById('previewImages');
        if (!previewImages) {
            console.error('previewImages element not found');
            return;
        }
        previewImages.innerHTML = '<div class="text-sm text-gray-500">Rasmlar yuklanmoqda...</div>';
        try {
            console.log('Loading images for document:', documentId);
            const response = await fetch(`/api/web/${documentId}/images/`);
            if (!response.ok) throw new Error('Response status ' + response.status);
            const data = await response.json();
            console.log('Images data received:', data);
            if (!data.images || data.images.length === 0) {
                previewImages.innerHTML = '<p class="text-sm text-gray-500">Rasm mavjud emas.</p>';
                return;
            }

            // For modal preview - show first image large, others in scroll
            const firstImage = data.images
                .slice()
                .sort((a, b) => (a.page_number || 0) - (b.page_number || 0))[0];

            if (firstImage) {
                const src = firstImage.large_url || firstImage.small_url || '';
                if (src) {
                    previewImages.innerHTML = `
                            <div class="preview-card-img w-full" oncontextmenu="return false;" ondragstart="return false;" onselectstart="return false;">
                                <img src="${src}" alt="Sahifa ${firstImage.page_number || 1}" loading="lazy" decoding="async" oncontextmenu="return false;" ondragstart="return false;" onselectstart="return false;" onerror="this.style.display='none';">
                            </div>
                        `;
                } else {
                    previewImages.innerHTML = '<p class="text-sm text-gray-500">Rasm mavjud emas.</p>';
                }
            } else {
                previewImages.innerHTML = '<p class="text-sm text-gray-500">Rasm mavjud emas.</p>';
            }

            const meta = [];
            if (data.page_count) meta.push(`${data.page_count} sahifa`);
            if (data.file_size) {
                const formatted = formatFileSize(data.file_size);
                if (formatted) meta.push(formatted);
            }
            const metaInfo = meta.length ? `<p class="text-xs text-gray-500 mt-2">${meta.join(' ‚Ä¢ ')}</p>` : '';

            if (!figures || figures.trim() === '') {
                console.warn('No figures generated from images');
                previewImages.innerHTML = '<p class="text-sm text-gray-500">Rasmlar yuklanmadi.</p>';
                return;
            }

            console.log('Rendering', data.images.length, 'images');
            previewImages.innerHTML = `
                    <div class="preview-scroll flex flex-col gap-4">
                        ${figures}
                    </div>
                    ${metaInfo}
                `;

            // Re-initialize feather icons after images are loaded
            setTimeout(() => {
                feather.replace();
            }, 100);
        } catch (error) {
            console.error('Rasmlar yuklashda xatolik:', error);
            previewImages.innerHTML = '<p class="text-sm text-red-500">Rasmlar yuklab bo\'lmadi: ' + error.message + '</p>';
        }
    }

    async function loadTopFiles() {
        console.log('loadTopFiles called');
        const loading = document.getElementById('loading');
        const topFiles = document.getElementById('topFiles');
        const topFilesSection = document.getElementById('topFilesSection');

        if (!topFilesSection || !topFiles || !loading) {
            console.error('Required elements not found:', {topFilesSection, topFiles, loading});
            return;
        }

        // Always show the section
        topFilesSection.classList.remove('hidden');
        loading.classList.remove('hidden');

        try {
            console.log('Fetching top downloads...');
            const response = await fetch('/api/web/top-downloads/');
            console.log('Response status:', response.status);

            if (!response.ok) {
                throw new Error(`Top files yuklanmadi: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            console.log('Top downloads data:', data);

            const files = data.results || data;

            if (files && files.length > 0) {
                console.log(`Rendering ${files.length} top files`);
                topFiles.innerHTML = files.map(file => renderFileCard(file)).join('');
                // Re-initialize feather icons
                feather.replace();
            } else {
                console.log('No top files found');
                topFiles.innerHTML = '<p class="text-center text-gray-500 col-span-full">Hozircha ommabop fayllar mavjud emas.</p>';
            }
        } catch (error) {
            console.error('Top files yuklashda xatolik:', error);
            topFiles.innerHTML = '<p class="text-center text-red-500 col-span-full">Xatolik yuz berdi: ' + error.message + '. Qaytadan urinib ko\'ring.</p>';
        } finally {
            loading.classList.add('hidden');
        }
    }

    function updateDeepSearchProgress(percentage, text, details = '', foundCount = 0) {
        const progressBar = document.getElementById('deepSearchBar');
        const progressPercent = document.getElementById('deepSearchPercent');
        const progressStatus = document.getElementById('deepSearchStatus');
        const progressDetails = document.getElementById('deepSearchDetails');
        const progressCount = document.getElementById('deepSearchCount');

        if (progressBar) {
            progressBar.style.width = `${percentage}%`;
        }
        if (progressPercent) {
            progressPercent.textContent = `${percentage}%`;
        }
        if (progressStatus) {
            progressStatus.textContent = text;
        }
        if (progressDetails && details) {
            progressDetails.textContent = details;
        }
        if (progressCount && foundCount > 0) {
            progressCount.innerHTML = `Topilgan fayllar: <span class="font-bold text-orange-200">${foundCount}</span>`;
        }
    }

    // Get batch number for a given page (batch 1 = pages 1-10, batch 2 = pages 11-20, etc.)
    function getBatchNumber(page) {
        return Math.ceil(page / BATCH_SIZE);
    }

    // Get pages in a batch (e.g., batch 1 = pages 1-10, batch 2 = pages 11-20)
    function getPagesInBatch(batchNum) {
        const start = (batchNum - 1) * BATCH_SIZE + 1;
        const end = batchNum * BATCH_SIZE;
        return {start, end};
    }

    // Check if page is in cache
    function isPageInCache(query, page) {
        if (!searchCache[query] || !searchCache[query].batches) return false;
        const batchNum = getBatchNumber(page);
        return searchCache[query].batches[batchNum] !== undefined;
    }

    // Get results for a specific page from cache
    function getPageFromCache(query, page) {
        if (!isPageInCache(query, page)) return null;
        const batchNum = getBatchNumber(page);
        const batchResults = searchCache[query].batches[batchNum];
        // Calculate which page this is within the batch (1-10)
        // Page 1-10: batch 1, page 1-10 in batch
        // Page 11-20: batch 2, page 1-10 in batch
        const firstPageInBatch = (batchNum - 1) * BATCH_SIZE + 1;
        const pageInBatch = page - firstPageInBatch + 1; // 1-10
        const startIdx = (pageInBatch - 1) * PAGE_SIZE;
        const endIdx = startIdx + PAGE_SIZE;
        return batchResults.slice(startIdx, endIdx);
    }

    async function performSearch(event, page = 1) {
        console.log('performSearch called:', {event, page, currentSearchQuery, isDeepMode});

        // Prevent default behavior and stop propagation
        if (event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            if (event.stopPropagation) {
                event.stopPropagation();
            }
        }

        let query;
        if (event === null) {
            // Pagination request - use current search query
            query = currentSearchQuery;
            console.log('Pagination request - using stored query:', query);
        } else {
            // New search request - get query from input
            query = document.getElementById('searchInput').value.trim();
            currentSearchQuery = query; // Store for pagination
            console.log('New search request - query:', query);
            // Clear cache for new search
            searchCache[query] = {batches: {}, total: 0, total_pages: 0};
        }

        if (!query) {
            console.log('No query found, returning');
            return;
        }

        const searchResults = document.getElementById('searchResults');
        const pagination = document.getElementById('pagination');
        const loading = document.getElementById('loading');
        const searchResultsSection = document.getElementById('searchResultsSection');
        const topFilesSection = document.getElementById('topFilesSection');
        const searchResultsCount = document.getElementById('searchResultsCount');
        const deepSearchProgress = document.getElementById('deepSearchProgress');

        // Show search results section, hide top files section
        searchResultsSection.classList.remove('hidden');
        topFilesSection.classList.add('hidden');

        // Check cache first for both deep and regular search
        if (isPageInCache(query, page)) {
            console.log(`Page ${page} found in cache, using cached data`);
            const cachedResults = getPageFromCache(query, page);
            const cacheData = searchCache[query];
            displaySearchResults({
                results: cachedResults,
                total: cacheData.total,
                page: page,
                page_size: PAGE_SIZE,
                total_pages: cacheData.total_pages,
                has_next: page < cacheData.total_pages,
                has_previous: page > 1,
                next_page: page + 1 <= cacheData.total_pages ? page + 1 : null,
                previous_page: page > 1 ? page - 1 : null,
                search_type: isDeepMode ? 'deep' : 'regular'
            }, page);
            return;
        }

        // Need to fetch data - show loading
        if (isDeepMode) {
            deepSearchProgress.classList.remove('hidden');
            updateDeepSearchProgress(0, 'Qidiruv boshlanmoqda...', 'Elasticsearch orqali qidirilmoqda...', 0);
        } else {
            loading.classList.remove('hidden');
        }

        searchResults.innerHTML = '';
        pagination.innerHTML = '';

        try {
            console.log('Starting API call...');

            // For deep search, show initial progress immediately
            if (isDeepMode) {
                updateDeepSearchProgress(5, 'Qidiruv boshlanmoqda...', 'Elasticsearch orqali qidirilmoqda...', 0);
            }

            // For deep search first page, fetch immediately without batch
            let apiUrl;
            if (isDeepMode && page === 1) {
                // First page - fetch immediately, no batch
                apiUrl = `/api/web/search/?q=${encodeURIComponent(query)}&page=1&deep=true&batch_start_page=0`;
                console.log('Deep search: fetching first page immediately');
            } else if (isDeepMode) {
                // Subsequent pages - use batch
                const batchNum = getBatchNumber(page);
                apiUrl = `/api/web/search/?q=${encodeURIComponent(query)}&page=${page}&deep=true&batch_start_page=${batchNum}`;
                console.log(`Deep search: fetching batch ${batchNum} (pages ${getPagesInBatch(batchNum).start}-${getPagesInBatch(batchNum).end})`);
            } else {
                apiUrl = `/api/web/search/?q=${encodeURIComponent(query)}&page=${page}&deep=false`;
            }

            // Update progress while fetching
            if (isDeepMode) {
                updateDeepSearchProgress(15, 'Elasticsearch orqali qidirilmoqda...', 'Fayl nomi va ichki matn qidirilmoqda...', 0);
            }

            // Start fetch - don't wait
            const fetchStartTime = Date.now();
            const response = await fetch(apiUrl);
            console.log('API call made:', apiUrl);

            if (!response.ok) throw new Error(`Qidiruv xatosi: ${response.status}`);
            const data = await response.json();
            console.log('API response:', data);

            const fetchTime = Date.now() - fetchStartTime;
            console.log(`Fetch completed in ${fetchTime}ms`);

            // For deep search, update progress with real count immediately
            if (isDeepMode && data.total !== undefined) {
                const totalFormatted = data.total >= 1000 ? `${(data.total / 1000).toFixed(0)} ming` : data.total;
                updateDeepSearchProgress(50, 'Natijalar topilmoqda...', `Topilgan: ${totalFormatted} ta fayl`, data.total);
            }

            if (isDeepMode) {
                // Cache the batch results
                if (!searchCache[query]) {
                    searchCache[query] = {batches: {}, total: 0, total_pages: 0};
                }

                // For first page, cache as batch 1
                if (page === 1 && data.results) {
                    searchCache[query].batches[1] = data.results;
                    searchCache[query].total = data.total;
                    searchCache[query].total_pages = data.total_pages;
                    console.log(`Cached first page with ${data.results.length} results`);
                } else if (data.is_batch && data.batch_start_page) {
                    searchCache[query].batches[data.batch_start_page] = data.results;
                    searchCache[query].total = data.total;
                    searchCache[query].total_pages = data.total_pages;
                    console.log(`Cached batch ${data.batch_start_page} with ${data.results.length} results`);
                }

                // Update progress - show that results are being displayed
                const totalFormatted = data.total >= 1000 ? `${(data.total / 1000).toFixed(0)} ming` : data.total;
                updateDeepSearchProgress(80, 'Natijalar ko\'rsatilmoqda...', `Topilgan: ${totalFormatted} ta fayl`, data.total);
            }

            currentSearchQuery = query;
            currentSearchMode = isDeepMode;

            // For deep search first page, display immediately
            if (isDeepMode && page === 1) {
                // First page - display immediately
                displaySearchResults(data, page);
            } else if (isDeepMode && data.is_batch) {
                // Subsequent pages - extract from batch
                const batchNum = getBatchNumber(page);
                const firstPageInBatch = (batchNum - 1) * BATCH_SIZE + 1;
                const pageInBatch = page - firstPageInBatch + 1; // 1-10
                const startIdx = (pageInBatch - 1) * PAGE_SIZE;
                const endIdx = startIdx + PAGE_SIZE;
                const pageResults = data.results.slice(startIdx, endIdx);

                displaySearchResults({
                    results: pageResults,
                    total: data.total,
                    page: page,
                    page_size: PAGE_SIZE,
                    total_pages: data.total_pages,
                    has_next: page < data.total_pages,
                    has_previous: page > 1,
                    next_page: page + 1 <= data.total_pages ? page + 1 : null,
                    previous_page: page > 1 ? page - 1 : null,
                    search_type: 'deep'
                }, page);
            } else {
                // Regular search or non-batch response
                displaySearchResults(data, page);
            }

            // Complete progress after results are displayed
            if (isDeepMode) {
                const totalFormatted = data.total >= 1000 ? `${(data.total / 1000).toFixed(0)} ming` : data.total;
                setTimeout(() => {
                    updateDeepSearchProgress(100, 'Tayyor!', `Qidiruv yakunlandi: ${totalFormatted} ta fayl topildi`, data.total);
                }, 200);
            }

        } catch (error) {
            console.error('API call error:', error);
            searchResults.innerHTML = '<p class="text-center text-red-500">Xatolik yuz berdi. Qaytadan urinib ko\'ring.</p>';
            topFilesSection.classList.remove('hidden');
        } finally {
            loading.classList.add('hidden');
            deepSearchProgress.classList.add('hidden');
        }
    }

    function displaySearchResults(data, page) {
        console.log('displaySearchResults called:', {data, page, resultsLength: data.results?.length});

        const searchResults = document.getElementById('searchResults');
        const pagination = document.getElementById('pagination');
        const searchResultsCount = document.getElementById('searchResultsCount');
        const deepSearchProgress = document.getElementById('deepSearchProgress');

        if (!pagination) {
            console.error('Pagination element not found!');
            return;
        }

        // Update results count immediately - realtime update
        if (searchResultsCount) {
            const totalFormatted = data.total >= 1000 ? `${(data.total / 1000).toFixed(0)} ming` : data.total;
            searchResultsCount.textContent = `${totalFormatted} ta natija`;
        }

        // Update deep search progress with real count
        if (isDeepMode && deepSearchProgress && !deepSearchProgress.classList.contains('hidden')) {
            const totalFormatted = data.total >= 1000 ? `${(data.total / 1000).toFixed(0)} ming` : data.total;
            updateDeepSearchProgress(85, 'Natijalar ko\'rsatilmoqda...', `Topilgan: ${totalFormatted} ta fayl`, data.total);
        }

        if (!data.results || data.results.length === 0) {
            console.log('No results found, showing empty message');
            if (searchResults) {
                searchResults.innerHTML = '<p class="text-center text-gray-500">Hech narsa topilmadi.</p>';
            }
            pagination.innerHTML = '';
            return;
        }

        console.log('Rendering results:', data.results.length, 'items');
        if (searchResults) {
            // Render results immediately - realtime display
            searchResults.innerHTML = data.results.map(file => renderFileCard(file)).join('');
            // Re-initialize feather icons immediately
            feather.replace();

            // Update progress after rendering
            if (isDeepMode && deepSearchProgress && !deepSearchProgress.classList.contains('hidden')) {
                updateDeepSearchProgress(95, 'Natijalar tayyor!', `Topilgan: ${data.total} ta fayl`, data.total);
            }
        }

        // Generate pagination with page numbers
        const currentPage = data.page;
        const totalPages = data.total_pages;
        const maxVisiblePages = 5;

        console.log('Generating pagination:', {
            currentPage,
            totalPages,
            hasPrevious: data.has_previous,
            hasNext: data.has_next
        });

        let paginationHTML = '<div class="flex items-center justify-center gap-2 flex-wrap">';

        // Previous button
        if (data.has_previous) {
            paginationHTML += `<button type="button" onclick="event.preventDefault(); event.stopPropagation(); performSearch(null, ${currentPage - 1})" class="pagination-button px-3 py-2 bg-primary hover:bg-orange-600 text-white rounded-lg transition-colors flex items-center gap-1">
                    <i data-feather="chevron-left" class="w-4 h-4"></i>
                    Orqaga
                </button>`;
        }

        // Page numbers
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        // Adjust start page if we're near the end
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // First page and ellipsis
        if (startPage > 1) {
            paginationHTML += `<button type="button" onclick="event.preventDefault(); event.stopPropagation(); performSearch(null, 1)" class="pagination-button px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors">1</button>`;
            if (startPage > 2) {
                paginationHTML += `<span class="px-2 text-gray-500">...</span>`;
            }
        }

        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHTML += `<button type="button" class="pagination-button active px-3 py-2 bg-primary text-white rounded-lg font-semibold" disabled>${i}</button>`;
            } else {
                paginationHTML += `<button type="button" onclick="event.preventDefault(); event.stopPropagation(); performSearch(null, ${i})" class="pagination-button px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors">${i}</button>`;
            }
        }

        // Last page and ellipsis
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<span class="px-2 text-gray-500">...</span>`;
            }
            paginationHTML += `<button type="button" onclick="event.preventDefault(); event.stopPropagation(); performSearch(null, ${totalPages})" class="pagination-button px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors">${totalPages}</button>`;
        }

        // Next button
        if (data.has_next) {
            paginationHTML += `<button type="button" onclick="event.preventDefault(); event.stopPropagation(); performSearch(null, ${currentPage + 1})" class="pagination-button px-3 py-2 bg-primary hover:bg-orange-600 text-white rounded-lg transition-colors flex items-center gap-1">
                    Keyingi
                    <i data-feather="chevron-right" class="w-4 h-4"></i>
                </button>`;
        }

        paginationHTML += '</div>';

        // Add page info
        paginationHTML += `<div class="text-center mt-4 text-sm text-gray-600">
                Sahifa ${currentPage} / ${totalPages} (${data.total} ta natija)
            </div>`;

        console.log('Setting pagination HTML:', paginationHTML.length, 'characters');
        console.log('Pagination HTML preview:', paginationHTML.substring(0, 200));

        if (pagination) {
            pagination.innerHTML = paginationHTML;
            console.log('Pagination rendered successfully');

            // Re-initialize feather icons for new buttons
            setTimeout(function () {
                feather.replace();
            }, 100);
        } else {
            console.error('Pagination element is null!');
        }
    }

    async function openFilePreview(productId, title, viewCount, downloadCount, documentId) {
        const modal = document.getElementById('filePreviewModal');
        const titleEl = document.getElementById('previewTitle');
        const titleElMobile = document.getElementById('previewTitleMobile');
        const viewsEl = document.getElementById('previewViews');
        const viewsElMobile = document.getElementById('previewViewsMobile');
        const downloadsEl = document.getElementById('previewDownloads');
        const telegramBtn = document.getElementById('telegramBtn');
        const previewImages = document.getElementById('previewImages');
        const previewMetadata = document.getElementById('previewMetadata');
        const previewPrice = document.getElementById('previewPrice');
        const previewTags = document.getElementById('previewTags');

        // Set titles
        if (titleEl) titleEl.textContent = title;
        if (titleElMobile) titleElMobile.textContent = title;

        // Set views
        if (viewsEl) viewsEl.textContent = viewCount;
        if (viewsElMobile) viewsElMobile.textContent = viewCount;

        // Set downloads
        if (downloadsEl) downloadsEl.textContent = downloadCount;

        // Set price (free for now)
        if (previewPrice) previewPrice.textContent = 'Bepul';

        // Set Telegram button
        telegramBtn.href = `https://t.me/${BOT_USERNAME}?start=${documentId}`;

        // Load images
        if (previewImages) {
            previewImages.innerHTML = '<div class="text-sm text-gray-500">Rasmlar yuklanmoqda...</div>';
        }

        // Load document metadata - use same API call as images
        loadDocumentMetadata(documentId);

        // Generate tags from title
        if (previewTags) {
            const tags = extractTagsFromTitle(title);
            if (tags.length > 0) {
                previewTags.innerHTML = tags.map(tag =>
                    `<span class="px-3 py-1 border-2 border-green-500 text-green-600 rounded-lg text-sm font-medium">${tag}</span>`
                ).join('');
            } else {
                previewTags.innerHTML = '';
            }
        }

        loadDocumentImages(documentId);

        // Force show modal with multiple methods
        modal.classList.remove('hidden');
        modal.classList.add('open');
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';

        // Store current counts for proper increment
        viewsEl.setAttribute('data-current-count', viewCount);
        downloadsEl.setAttribute('data-current-count', downloadCount);

        incrementViewCount(productId);
    }

    function closeFilePreview() {
        const modal = document.getElementById('filePreviewModal');
        modal.classList.remove('open');
        modal.classList.add('hidden');
    }

    function openFeedbackModal() {
        const modal = document.getElementById('feedbackModal');
        modal.classList.remove('hidden');
        modal.classList.add('open');
    }

    function closeFeedbackModal() {
        const modal = document.getElementById('feedbackModal');
        modal.classList.remove('open');
        modal.classList.add('hidden');
    }

    document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const resultEl = document.getElementById('fbResult');
        try {
            const response = await fetch('/api/web/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    contact: document.getElementById('fbContact').value,
                    message: document.getElementById('fbMessage').value,
                })
            });
            if (!response.ok) throw new Error('Server xatosi');
            resultEl.textContent = 'Rahmat! Fikringiz qabul qilindi.';
            resultEl.className = 'text-sm text-green-600 text-center';
            e.target.reset();
            setTimeout(closeFeedbackModal, 2000);
        } catch (error) {
            resultEl.textContent = 'Xatolik yuz berdi. Qaytadan urinib ko\'ring.';
            resultEl.className = 'text-sm text-red-600 text-center';
        }
    });

    document.getElementById('deepToggle').addEventListener('change', (e) => {
        isDeepMode = e.target.checked;
        const searchInfo = document.getElementById('searchInfo');
        const searchInput = document.getElementById('searchInput');
        const searchSection = document.querySelector('.animated-gradient');

        // Gradient rangini o'zgartirish
        if (isDeepMode) {
            searchSection.classList.add('deep-search');
            searchInfo.innerHTML = '<span class="font-semibold text-red-300">Chuqurlashtirilgan Qidiruv:</span> Fayl ichidan ham qidirish';
        } else {
            searchSection.classList.remove('deep-search');
            searchInfo.innerHTML = '<span class="font-semibold text-orange-300">Oddiy Qidiruv:</span> Faqat fayl nomi bilan qidirish';
        }

        // Deep search toggle - force new search with current query
        if (searchInput.value.trim()) {
            console.log('Deep search toggle - performing new search');
            currentSearchQuery = searchInput.value.trim(); // Update current query
            performSearch(null, 1);
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeFilePreview();
            closeFeedbackModal();
        }
    });
    document.getElementById('filePreviewModal').addEventListener('click', (e) => e.target === e.currentTarget && closeFilePreview());

    async function incrementViewCount(productId) {
        try {
            const response = await fetch(`/api/web/${productId}/view/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });

            if (response.ok) {
                console.log('Ko\'rishlar soni oshirildi');
                updateViewCountInUI(productId);
            }
        } catch (error) {
            console.error('Ko\'rishlar sonini oshirishda xatolik:', error);
        }
    }

    async function incrementDownloadCount(productId) {
        try {
            const response = await fetch(`/api/web/${productId}/download/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });

            if (response.ok) {
                console.log('Yuklab olishlar soni oshirildi');
                updateDownloadCountInUI(productId);
            }
        } catch (error) {
            console.error('Yuklab olishlar sonini oshirishda xatolik:', error);
        }
    }

    function updateViewCountInUI(productId) {
        const viewsElement = document.getElementById('previewViews');
        if (viewsElement) {
            // Use stored count or current text content
            const storedCount = viewsElement.getAttribute('data-current-count');
            const currentViews = storedCount ? parseInt(storedCount) : (parseInt(viewsElement.textContent) || 0);
            const newCount = currentViews + 1;
            viewsElement.textContent = newCount;
            viewsElement.setAttribute('data-current-count', newCount);
        }

        const fileCard = document.querySelector(`[data-product-id="${productId}"]`);
        if (fileCard) {
            const viewsSpan = fileCard.querySelector('.views-count');
            if (viewsSpan) {
                const currentViews = parseInt(viewsSpan.textContent) || 0;
                viewsSpan.textContent = currentViews + 1;
            }
        }
    }

    function updateDownloadCountInUI(productId) {
        const downloadsElement = document.getElementById('previewDownloads');
        if (downloadsElement) {
            // Use stored count or current text content
            const storedCount = downloadsElement.getAttribute('data-current-count');
            const currentDownloads = storedCount ? parseInt(storedCount) : (parseInt(downloadsElement.textContent) || 0);
            const newCount = currentDownloads + 1;
            downloadsElement.textContent = newCount;
            downloadsElement.setAttribute('data-current-count', newCount);
        }

        const fileCard = document.querySelector(`[data-product-id="${productId}"]`);
        if (fileCard) {
            const downloadsSpan = fileCard.querySelector('.downloads-count');
            if (downloadsSpan) {
                const currentDownloads = parseInt(downloadsSpan.textContent) || 0;
                downloadsSpan.textContent = currentDownloads + 1;
            }
        }
    }

    function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }

    // Video optimization and lazy loading
    function optimizeVideo() {
        const video = document.querySelector('video');
        if (!video) return;

        // Check if already initialized to prevent multiple event listeners
        if (video.hasAttribute('data-initialized')) return;
        video.setAttribute('data-initialized', 'true');

        // Intersection Observer for lazy loading
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Load video when it comes into view
                    const videoElement = entry.target;
                    const dataSrc = videoElement.dataset.src;
                    if (dataSrc && !videoElement.src) {
                        videoElement.src = dataSrc;
                        videoElement.load();
                    }
                }
            });
        });
        observer.observe(video);
    }

    // Initialize video optimization
    optimizeVideo();

    // Prevent image download - global handlers
    document.addEventListener('contextmenu', function (e) {
        if (e.target.tagName === 'IMG' && e.target.closest('.preview-card-img')) {
            e.preventDefault();
            return false;
        }
    }, false);

    document.addEventListener('dragstart', function (e) {
        if (e.target.tagName === 'IMG' && e.target.closest('.preview-card-img')) {
            e.preventDefault();
            return false;
        }
    }, false);

    document.addEventListener('selectstart', function (e) {
        if (e.target.tagName === 'IMG' && e.target.closest('.preview-card-img')) {
            e.preventDefault();
            return false;
        }
    }, false);

    // Prevent right-click on images
    document.addEventListener('mousedown', function (e) {
        if (e.button === 2 && e.target.tagName === 'IMG' && e.target.closest('.preview-card-img')) {
            e.preventDefault();
            return false;
        }
    }, false);
</script>
<script>
    // Global o'zgaruvchilar
    const modal = document.getElementById('detailModal');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContainer = document.getElementById('modalContainer');
    const modalImagePart = document.getElementById('modalImagePart');
    const modalInfoPart = document.getElementById('modalInfoPart');

    function openDetailModal(docId, title, size, downloads, views, fileUrl, extension) {
        // 1. Modalni ochish (Animatsiya bilan)
        modal.classList.remove('hidden');
        // Kichik "timeout" animatsiya silliq ishlashi uchun kerak
        setTimeout(() => {
            modalBackdrop.classList.remove('opacity-0');
            modalContainer.classList.remove('opacity-0', 'scale-95');
            modalContainer.classList.add('opacity-100', 'scale-100');
        }, 10);

        // 2. Boshlang'ich ma'lumotlarni to'ldirish
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalSize').innerText = size || 'Noma\'lum';
        document.getElementById('modalDownloads').innerText = downloads;
        document.getElementById('modalViews').innerText = views;
        document.getElementById('modalDownloadBtn').href = fileUrl; // To'g'ridan-to'g'ri yuklash havolasi

        // Iconni to'g'irlash (Formatga qarab)
        const iconEl = document.getElementById('fileTypeIcon');
        if (extension === 'pdf') iconEl.className = 'feather-file-text w-10 h-10';
        else if (['doc', 'docx'].includes(extension)) iconEl.className = 'feather-file w-10 h-10';
        else iconEl.className = 'feather-file w-10 h-10';

        // 3. Reset (Oldingi holatni tozalash)
        resetModalState();

        // 4. API orqali rasmlarni tekshirish (Backend: views.document_images)
        fetch(`/api/web/${docId}/images/`)
            .then(response => response.json())
            .then(data => {
                if (data.images && data.images.length > 0) {
                    // A) RASM BOR: Katta rejimga o'tkazish
                    enableLargeModal(data.images[0].image, data.count);
                } else {
                    // B) RASM YO'Q: Kichik rejimda qoldirish
                    enableSmallModal();
                }
            })
            .catch(err => {
                console.error('Rasm yuklashda xatolik:', err);
                enableSmallModal();
            });
    }

    function resetModalState() {
        // Default holat: Rasm qismi yashirin, oyna kichkina
        modalContainer.className = "relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 w-full max-w-md opacity-100 scale-100 duration-300";
        modalImagePart.classList.add('hidden');
        modalInfoPart.className = "w-full p-6 md:p-8 flex flex-col justify-center";
        document.getElementById('modalFallbackIcon').classList.remove('hidden');
        document.getElementById('modalMainImage').classList.add('hidden');
        document.getElementById('imageLoader').classList.remove('hidden');
    }

    function enableLargeModal(imageUrl, count) {
        // Konteynerni kengaytiramiz (max-w-4xl)
        modalContainer.classList.remove('max-w-md');
        modalContainer.classList.add('max-w-4xl');

        // Rasmni ko'rsatamiz
        modalImagePart.classList.remove('hidden'); // Chap tomonni ochish
        modalInfoPart.className = "w-full md:w-1/2 p-6 md:p-8 flex flex-col justify-center"; // O'ng tomonni moslash

        // Fallback iconni yashiramiz
        document.getElementById('modalFallbackIcon').classList.add('hidden');

        // Rasmni yuklash
        const imgEl = document.getElementById('modalMainImage');
        imgEl.src = imageUrl;
        imgEl.onload = () => {
            document.getElementById('imageLoader').classList.add('hidden');
            imgEl.classList.remove('hidden');

            if (count > 1) {
                document.getElementById('imageCountBadge').classList.remove('hidden');
                document.getElementById('imgCount').innerText = count;
            }
        };
    }

    function enableSmallModal() {
        // Konteyner kichikligicha qoladi (max-w-md)
        modalContainer.classList.add('max-w-md');
        modalContainer.classList.remove('max-w-4xl');

        // Rasm qismini yashiramiz
        modalImagePart.classList.add('hidden');

        // Iconni ko'rsatamiz
        document.getElementById('modalFallbackIcon').classList.remove('hidden');
    }

    function closeDetailModal() {
        modalBackdrop.classList.add('opacity-0');
        modalContainer.classList.add('opacity-0', 'scale-95');
        modalContainer.classList.remove('opacity-100', 'scale-100');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('modalMainImage').src = ''; // Xotirani tozalash
        }, 300);
    }

    // Tashqariga bosilganda yopish (HTML da onclick bor, lekin bu zaxira)
    window.onclick = function (event) {
        if (event.target == modal) {
            closeDetailModal();
        }
    }
</script>
</body>
</html>
